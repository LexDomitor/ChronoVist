<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLine | Atlas</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@300&display=swap');
        
        :root { 
            --bg: #000; 
            --ui-bg: #0d0d0d; 
            --text-primary: #fff;
            --text-dim: #999; 
            --accent: #fff; 
            --danger: #ff4444; 
            --border: #333;
            --node-bg: rgba(15, 15, 15, 0.75);
            --panel-bg: rgba(12, 12, 12, 0.85);
        }

        html, body { 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            width: 100vw; 
            background: var(--bg); 
            color: #fff; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .atlas-panel {
            background: var(--panel-bg);
            border: 2px solid var(--border);
            padding: 1rem;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.05);
            overflow: hidden;
            box-sizing: border-box;
        }
        
        .atlas-content {
            display: flex;
            gap: 1rem;
            flex: 1;
            min-height: 0;
            position: relative;
            transition: gap 0.3s ease;
        }
        
        .atlas-content.controls-collapsed { gap: 0; }
        
        .atlas-left-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 140px;
            width: 140px;
            flex-shrink: 0;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .atlas-controls-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
            flex: 1;
            padding-right: 20px;
            padding-top: 40px;
        }
        
        .atlas-map-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        
        .atlas-title-container {
            display: flex;
            align-items: center;
            width: 600px;
            max-width: min(600px, 80vw);
            justify-content: center;
            position: relative;
        }
        
        .atlas-close-x {
            background: transparent;
            border: 1px solid var(--border);
            color: #888;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: 0.2s;
            position: absolute;
            right: 0;
        }
        
        .atlas-close-x:hover { background: #222; color: white; }
        
        .atlas-title-input {
            background: transparent;
            border: none;
            color: #999;
            font-size: 2rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: -1px;
            text-align: center;
            font-family: inherit;
            outline: none;
            width: calc(100% - 80px);
            margin: 0 auto;
            transition: font-size 0.2s;
        }
        
        .atlas-title-input:focus { color: white; }
        .atlas-title-input.overflow { font-size: 1.5rem; }
        
        .atlas-map-container {
            width: 600px;
            height: 600px;
            max-width: min(600px, 80vw);
            max-height: min(600px, 80vh);
            background: #000;
            border: 2px solid var(--border);
            position: relative;
            overflow: hidden;
            cursor: zoom-in;
        }
        
        .atlas-map-container.zoomed { cursor: zoom-out; }
        .atlas-map-container.waypoint-mode { cursor: crosshair; }
        
        .atlas-map-inner-border {
            position: absolute;
            top: 8px; left: 8px; right: 8px; bottom: 8px;
            border: 1px solid var(--border);
            pointer-events: none;
            z-index: 3;
        }
        
        .atlas-map-display {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .atlas-map-viewport {
            width: 100%;
            height: 100%;
            position: relative;
            transform-origin: center center;
            transition: transform 0.3s ease;
        }
        
        .atlas-placeholder {
            color: #444;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
        }
        
        .atlas-placeholder-sub {
            color: #333;
            font-size: 0.55rem;
            margin-top: 0.8rem;
            line-height: 1.4;
        }
        
        .atlas-map-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            user-select: none;
        }
        
        .atlas-waypoint {
            position: absolute;
            width: 24px;
            height: 24px;
            margin-left: -12px;
            margin-top: -12px;
            background: #ff4444;
            border: 2px solid white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            cursor: pointer;
            z-index: 2;
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        
        .atlas-waypoint:hover {
            transform: rotate(-45deg) scale(1.2);
            background: #ff6666;
        }
        
        .atlas-waypoint::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
        }
        
        .atlas-waypoint.dragging {
            animation: pulse-waypoint 0.6s ease-in-out infinite;
            z-index: 10;
        }
        
        @keyframes pulse-waypoint {
            0%, 100% { 
                transform: rotate(-45deg) scale(1);
                box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            }
            50% { 
                transform: rotate(-45deg) scale(1.3);
                box-shadow: 0 4px 16px rgba(255,255,100,0.8);
            }
        }
        
        .waypoint-hover-tooltip {
            position: fixed;
            background: #1a1a1a;
            border: 2px solid var(--border);
            border-radius: 4px;
            padding: 0.6rem 0.9rem;
            font-size: 0.75rem;
            color: var(--text-primary);
            pointer-events: none;
            z-index: 100001;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.8);
            white-space: nowrap;
        }
        
        .waypoint-hover-tooltip.active { display: block; }
        .waypoint-hover-title { font-weight: 600; margin-bottom: 0.3rem; color: white; }
        .waypoint-hover-coords { font-size: 0.65rem; color: var(--text-dim); }
        
        .zoom-warning-tooltip {
            position: fixed;
            background: #1a1a1a;
            border: 2px solid #ffcc55;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 0.7rem;
            color: #ffcc55;
            pointer-events: none;
            z-index: 100003;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 12px rgba(255, 204, 85, 0.3);
            white-space: nowrap;
        }
        
        .zoom-warning-tooltip.show {
            opacity: 1;
        }
        
        .atlas-collapse-toggle {
            position: absolute;
            right: -16px;
            top: 0; bottom: 0;
            width: 16px;
            background: var(--panel-bg);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-dim);
            font-size: 0.7rem;
            transition: 0.2s;
            z-index: 5;
        }
        
        .atlas-collapse-toggle:hover { background: #222; color: white; }
        
        .atlas-content.controls-collapsed .atlas-left-controls {
            width: 0; min-width: 0; opacity: 0;
        }
        
        .atlas-expand-btn {
            position: absolute;
            left: -16px;
            top: 0; bottom: 0;
            width: 16px;
            background: var(--panel-bg);
            border: none;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-dim);
            font-size: 0.7rem;
            transition: 0.2s;
            z-index: 5;
        }
        
        .atlas-expand-btn:hover { background: #222; color: white; }
        .atlas-content.controls-collapsed .atlas-expand-btn { display: flex; }
        
        #move-waypoint-btn {
            background: #1a1505;
            border: 1px solid #665522;
            color: #ccaa44;
        }
        
        #move-waypoint-btn:hover { background: #2a2008; color: #ffcc55; }
        #move-waypoint-btn.active { background: #ffcc55; color: #000; border-color: #ffdd77; font-weight: 600; }
        
        #remove-waypoint-btn {
            background: #1a0505;
            border: 1px solid #662222;
            color: #cc4444;
        }
        
        #remove-waypoint-btn:hover { background: #2a0808; color: #ff5555; }
        #remove-waypoint-btn.active { background: #ff5555; color: white; border-color: #ff7777; }
        
        .atlas-grid-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 1;
        }
        
        .atlas-grid-line {
            position: absolute;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .atlas-grid-line.horizontal { width: 100%; height: 1px; }
        .atlas-grid-line.vertical { width: 1px; height: 100%; }
        
        .atlas-btn {
            width: 100%;
            padding: 0.5rem 0.6rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            font-family: inherit;
            transition: 0.2s;
            text-align: center;
        }
        
        .atlas-btn:hover { background: #222; color: white; }
        .atlas-btn.active { background: #333; color: white; border-color: #555; }
        
        .atlas-grid-control {
            display: none;
            width: 100%;
            padding: 0.6rem;
            background: #111;
            border: 1px solid var(--border);
        }
        
        .atlas-grid-control.active { display: block; }
        
        .atlas-grid-slider {
            width: 100%;
            height: 20px;
            background: #222;
            border: 1px solid var(--border);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        
        .atlas-grid-slider-fill {
            height: 100%;
            background: var(--text-dim);
            position: relative;
            border-radius: 1px;
        }
        
        .atlas-grid-slider-thumb {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 20px;
            background: white;
            cursor: grab;
            border-left: 1px solid #000;
        }
        
        .atlas-grid-slider-thumb:active { cursor: grabbing; }
        
        .atlas-grid-value {
            color: var(--text-primary);
            font-size: 0.6rem;
            text-align: center;
            margin-top: 0.4rem;
            display: block;
        }
        
        .upload-menu-overlay, .waypoint-edit-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100000;
        }
        
        .upload-menu-overlay.active, .waypoint-edit-overlay.active { display: flex; }
        
        .upload-menu-panel, .waypoint-edit-panel {
            background: var(--panel-bg);
            border: 2px solid var(--border);
            padding: 2rem;
            min-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .upload-menu-header, .waypoint-edit-header {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }
        
        .upload-menu-input, .waypoint-edit-input {
            width: 100%;
            background: #000;
            border: 1px solid var(--border);
            padding: 0.8rem;
            color: white;
            font-family: inherit;
            font-size: 0.8rem;
            outline: none;
            box-sizing: border-box;
        }
        
        .waypoint-edit-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.3rem;
        }
        
        .waypoint-edit-textarea {
            width: 100%;
            background: #000;
            border: 1px solid var(--border);
            padding: 0.6rem;
            color: white;
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
            resize: none;
            height: 60px;
            box-sizing: border-box;
        }
        
        .waypoint-char-count {
            font-size: 0.5rem;
            text-align: right;
            color: var(--text-dim);
            margin-top: 0.3rem;
        }
        
        .upload-menu-buttons {
            display: flex;
            gap: 0.8rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="atlas-panel">
        <div class="atlas-content" id="atlas-content">
            <button class="atlas-expand-btn" onclick="toggleAtlasControls()">◄</button>
            
            <div class="atlas-left-controls" id="atlas-left-controls">
                <div class="atlas-controls-group">
                    <button class="atlas-btn" onclick="openUploadMenu()">Upload New Image</button>
                    <button class="atlas-btn" id="waypoint-mode-btn" onclick="toggleWaypointMode()">+ New Waypoint</button>
                    <button class="atlas-btn" id="move-waypoint-btn" style="display: none;" onclick="toggleMoveWaypointMode()">Move Waypoint</button>
                    <button class="atlas-btn" id="remove-waypoint-btn" style="display: none;" onclick="toggleRemoveWaypointMode()">- Remove Waypoint</button>
                    <button class="atlas-btn" id="grid-scale-btn" onclick="toggleGridControl()">Grid Scale</button>
                    
                    <div class="atlas-grid-control" id="atlas-grid-control">
                        <div class="atlas-grid-slider" id="atlas-grid-slider" onmousedown="startGridSlider(event)">
                            <div class="atlas-grid-slider-fill" id="atlas-grid-slider-fill">
                                <div class="atlas-grid-slider-thumb"></div>
                            </div>
                        </div>
                        <span class="atlas-grid-value" id="atlas-grid-value">0</span>
                    </div>
                    
                    <button class="atlas-btn" onclick="resetAtlasView()">Reset View</button>
                </div>
                
                <div class="atlas-collapse-toggle" onclick="toggleAtlasControls()">►</div>
            </div>
            
            <div class="atlas-map-section">
                <div class="atlas-title-container">
                    <div class="atlas-close-x" onclick="closeAtlas()">×</div>
                    <input type="text" class="atlas-title-input" id="atlas-title-input" placeholder="World Atlas" maxlength="60" oninput="handleAtlasTitleInput(this)" value="World Atlas">
                </div>
                
                <div class="atlas-map-container" id="atlas-map-container" onclick="handleAtlasClick(event)" onmousemove="handleAtlasMouseMove(event)" onmousedown="handleAtlasMouseDown(event)" onmouseup="handleAtlasMouseUp()" onmouseleave="handleAtlasMouseUp()" onwheel="handleAtlasZoom(event)" tabindex="0">
                    <div class="atlas-map-inner-border"></div>
                    <div class="atlas-map-display" id="atlas-map-display">
                        <div class="atlas-map-viewport" id="atlas-map-viewport">
                            <div id="atlas-grid-overlay" class="atlas-grid-overlay"></div>
                            <div id="atlas-waypoints-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
                            <div id="atlas-placeholder" class="atlas-placeholder">
                                No map uploaded
                                <div class="atlas-placeholder-sub">Recommended: Square images<br>(512×512, 1024×1024, 2048×2048)</div>
                            </div>
                            <img id="atlas-map-image" class="atlas-map-image" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="waypoint-hover-tooltip" id="waypoint-hover-tooltip">
        <div class="waypoint-hover-title" id="waypoint-hover-title"></div>
        <div class="waypoint-hover-coords" id="waypoint-hover-coords"></div>
    </div>
    
    <div class="zoom-warning-tooltip" id="zoom-warning-tooltip">Toggle Waypoint Mode off to Zoom Map</div>
    
    <div class="upload-menu-overlay" id="upload-menu-overlay" onclick="closeUploadMenu(event)">
        <div class="upload-menu-panel" onclick="event.stopPropagation()">
            <div class="upload-menu-header">Upload Map Image</div>
            <input type="file" id="atlas-upload" hidden accept="image/*" onchange="handleAtlasUpload(this)">
            <button class="atlas-btn" onclick="document.getElementById('atlas-upload').click()">Choose Local File</button>
            <div style="text-align: center; color: #666; font-size: 0.7rem; margin: 0.5rem 0;">OR</div>
            <input type="text" class="upload-menu-input" id="atlas-url-input" placeholder="Enter image URL" oninput="handleAtlasURLInput(this)">
            <div class="upload-menu-buttons">
                <button class="atlas-btn" style="flex: 1;" onclick="closeUploadMenu()">Close</button>
            </div>
        </div>
    </div>
    
    <div class="waypoint-edit-overlay" id="waypoint-edit-overlay" onclick="closeWaypointEdit(event)">
        <div class="waypoint-edit-panel" onclick="event.stopPropagation()">
            <div class="waypoint-edit-header">Waypoint Details</div>
            <div>
                <div class="waypoint-edit-label">Title</div>
                <input type="text" class="waypoint-edit-input" id="waypoint-title-input" placeholder="Enter waypoint name" maxlength="60">
            </div>
            <div>
                <div class="waypoint-edit-label">Description</div>
                <textarea class="waypoint-edit-textarea" id="waypoint-desc-input" placeholder="Brief description..." maxlength="150" oninput="updateWaypointCharCount()"></textarea>
                <div class="waypoint-char-count" id="waypoint-char-count">0 / 150</div>
            </div>
            <div class="upload-menu-buttons">
                <button class="atlas-btn" style="flex: 1;" onclick="saveWaypointDetails()">Save</button>
                <button class="atlas-btn" style="flex: 1;" onclick="closeWaypointEdit()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // IndexedDB for image storage
        let imageDB = null;
        const DB_NAME = 'alphaline_images';
        const DB_VERSION = 1;
        const IMAGE_STORE = 'images';

        function initImageDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { imageDB = request.result; resolve(imageDB); };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(IMAGE_STORE)) {
                        db.createObjectStore(IMAGE_STORE);
                    }
                };
            });
        }

        async function storeImage(key, blob) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([IMAGE_STORE], 'readwrite');
                const store = transaction.objectStore(IMAGE_STORE);
                const request = store.put(blob, key);
                request.onsuccess = () => resolve(key);
                request.onerror = () => reject(request.error);
            });
        }

        async function getImage(key) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([IMAGE_STORE], 'readonly');
                const store = transaction.objectStore(IMAGE_STORE);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Get universe ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const universeId = urlParams.get('id');

        // Atlas State
        let atlasImage = null;
        let atlasGridScale = 0;
        let atlasWaypoints = [];
        let atlasZoom = 1;
        let waypointMode = false;
        let moveWaypointMode = false;
        let removeWaypointMode = false;
        let atlasTitle = "World Atlas";
        let editingWaypointIndex = null;
        let atlasControlsCollapsed = false;
        let atlasDragging = false;
        let atlasDragStart = { x: 0, y: 0 };
        let atlasTooltipTimeout = null;
        
        // Waypoint dragging state
        let draggingWaypoint = false;
        let draggingWaypointIndex = null;

        // Load atlas data from localStorage (shared with workspace.html)
        async function loadAtlasData() {
            if (!universeId) {
                console.error('No universeId - cannot load atlas data');
                return;
            }
            
            console.log('Loading atlas data for universe:', universeId);
            
            const storageKey = `alphaline_universe_${universeId}`;
            const saved = localStorage.getItem(storageKey);
            
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    atlasImage = data.atlasImage || null;
                    atlasGridScale = data.atlasGridScale || 0;
                    atlasWaypoints = data.atlasWaypoints || [];
                    atlasTitle = data.atlasTitle || "World Atlas";
                    
                    console.log('✓ Atlas data loaded:', {
                        image: atlasImage ? (atlasImage.startsWith('indexeddb:') ? 'IndexedDB ref' : 'URL') : 'none',
                        gridScale: atlasGridScale,
                        waypointCount: atlasWaypoints.length,
                        title: atlasTitle
                    });
                    
                    const titleInput = document.getElementById('atlas-title-input');
                    titleInput.value = atlasTitle;
                    if (atlasTitle.length > 40) titleInput.classList.add('overflow');
                    
                    const imgElement = document.getElementById('atlas-map-image');
                    const placeholder = document.getElementById('atlas-placeholder');
                    
                    if (atlasImage) {
                        if (atlasImage.startsWith('indexeddb:')) {
                            const imageKey = atlasImage.replace('indexeddb:', '');
                            try {
                                const blob = await getImage(imageKey);
                                if (blob) {
                                    imgElement.src = URL.createObjectURL(blob);
                                    imgElement.style.display = 'block';
                                    placeholder.style.display = 'none';
                                }
                            } catch (error) {
                                console.error('Failed to load atlas image:', error);
                            }
                        } else {
                            imgElement.src = atlasImage;
                            imgElement.style.display = 'block';
                            placeholder.style.display = 'none';
                        }
                    }
                    
                    updateGridSliderUI();
                    updateAtlasGrid();
                    renderWaypoints();
                } catch (error) {
                    console.error('Failed to load atlas data:', error);
                }
            } else {
                console.log('No saved atlas data found for universe:', universeId);
            }
        }

        // Save atlas data to localStorage (shared with workspace.html)
        function saveAtlasData() {
            if (!universeId) {
                console.error('No universeId - cannot save atlas data');
                return;
            }
            
            console.log('Saving atlas data:', {
                image: atlasImage ? (atlasImage.startsWith('indexeddb:') ? 'IndexedDB ref' : 'URL') : 'none',
                gridScale: atlasGridScale,
                waypointCount: atlasWaypoints.length,
                title: atlasTitle
            });
            
            const storageKey = `alphaline_universe_${universeId}`;
            const saved = localStorage.getItem(storageKey);
            
            try {
                let data = saved ? JSON.parse(saved) : { years: [], plots: {}, characters: [], glossary: [] };
                data.atlasImage = atlasImage;
                data.atlasGridScale = atlasGridScale;
                data.atlasWaypoints = atlasWaypoints;
                data.atlasTitle = atlasTitle;
                localStorage.setItem(storageKey, JSON.stringify(data));
                
                console.log('✓ Atlas data saved successfully');
                
                // Notify parent window
                if (window.parent !== window) {
                    window.parent.postMessage({ type: 'ATLAS_UPDATED' }, '*');
                }
            } catch (error) {
                console.error('Failed to save atlas data:', error);
            }
        }

        function closeAtlas() {
            saveAtlasData();
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'CLOSE_ATLAS' }, '*');
            }
        }

        function toggleAtlasControls() {
            atlasControlsCollapsed = !atlasControlsCollapsed;
            const content = document.getElementById('atlas-content');
            content.classList.toggle('controls-collapsed', atlasControlsCollapsed);
        }
        
        function deactivateAllModes() {
            waypointMode = false;
            moveWaypointMode = false;
            removeWaypointMode = false;
            document.getElementById('atlas-grid-control').classList.remove('active');
            document.getElementById('grid-scale-btn').classList.remove('active');
            updateWaypointModeUI();
        }
        
        function openUploadMenu() {
            deactivateAllModes();
            document.getElementById('upload-menu-overlay').classList.add('active');
        }
        
        function closeUploadMenu(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('upload-menu-overlay').classList.remove('active');
            document.getElementById('atlas-url-input').value = '';
        }
        
        function handleAtlasURLInput(input) {
            const url = input.value.trim();
            if (url) {
                atlasImage = url;
                saveAtlasData();
                
                const imgElement = document.getElementById('atlas-map-image');
                const placeholder = document.getElementById('atlas-placeholder');
                imgElement.src = url;
                imgElement.style.display = 'block';
                placeholder.style.display = 'none';
                
                setTimeout(() => closeUploadMenu(), 300);
            }
        }
        
        async function handleAtlasUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const imageKey = `atlas_${universeId}_${Date.now()}`;
            try {
                await storeImage(imageKey, file);
                atlasImage = `indexeddb:${imageKey}`;
                saveAtlasData();
                
                const imgElement = document.getElementById('atlas-map-image');
                const placeholder = document.getElementById('atlas-placeholder');
                imgElement.src = URL.createObjectURL(file);
                imgElement.style.display = 'block';
                placeholder.style.display = 'none';
                
                closeUploadMenu();
            } catch (error) {
                console.error('Failed to store atlas image:', error);
                alert('Failed to store image. Please try a smaller file.');
            }
        }
        
        function toggleWaypointMode() {
            removeWaypointMode = false;
            moveWaypointMode = false;
            document.getElementById('atlas-grid-control').classList.remove('active');
            document.getElementById('grid-scale-btn').classList.remove('active');
            
            waypointMode = !waypointMode;
            updateWaypointModeUI();
        }
        
        function toggleMoveWaypointMode() {
            waypointMode = false;
            removeWaypointMode = false;
            document.getElementById('atlas-grid-control').classList.remove('active');
            document.getElementById('grid-scale-btn').classList.remove('active');
            
            moveWaypointMode = !moveWaypointMode;
            updateWaypointModeUI();
        }
        
        function toggleRemoveWaypointMode() {
            waypointMode = false;
            moveWaypointMode = false;
            document.getElementById('atlas-grid-control').classList.remove('active');
            document.getElementById('grid-scale-btn').classList.remove('active');
            
            removeWaypointMode = !removeWaypointMode;
            updateWaypointModeUI();
        }
        
        function updateWaypointModeUI() {
            const waypointBtn = document.getElementById('waypoint-mode-btn');
            const moveBtn = document.getElementById('move-waypoint-btn');
            const removeBtn = document.getElementById('remove-waypoint-btn');
            const container = document.getElementById('atlas-map-container');
            
            waypointBtn.classList.toggle('active', waypointMode);
            moveBtn.classList.toggle('active', moveWaypointMode);
            removeBtn.classList.toggle('active', removeWaypointMode);
            
            // Show move and remove buttons when waypoint mode is active
            moveBtn.style.display = (waypointMode || moveWaypointMode || removeWaypointMode) ? 'block' : 'none';
            removeBtn.style.display = (waypointMode || moveWaypointMode || removeWaypointMode) ? 'block' : 'none';
            
            container.classList.toggle('waypoint-mode', waypointMode || moveWaypointMode || removeWaypointMode);
            
            if (!waypointMode && !moveWaypointMode && !removeWaypointMode) {
                container.classList.remove('waypoint-mode');
            }
        }
        
        function handleAtlasClick(event) {
            // Skip if we're in move mode (dragging is handled separately)
            if (moveWaypointMode) return;
            
            if (!waypointMode && !removeWaypointMode) return;
            
            const container = document.getElementById('atlas-map-container');
            const viewport = document.getElementById('atlas-map-viewport');
            const rect = container.getBoundingClientRect();
            
            // Get the current transform values
            const transform = viewport.style.transform;
            let translateX = 0, translateY = 0, scale = atlasZoom;
            
            if (transform) {
                const translateMatch = transform.match(/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/);
                const scaleMatch = transform.match(/scale\(([-\d.]+)\)/);
                if (translateMatch) {
                    translateX = parseFloat(translateMatch[1]);
                    translateY = parseFloat(translateMatch[2]);
                }
                if (scaleMatch) {
                    scale = parseFloat(scaleMatch[1]);
                }
            }
            
            // Calculate click position accounting for zoom and pan
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;
            
            // Reverse the transform to get original coordinates
            const originalX = (clickX - translateX) / scale;
            const originalY = (clickY - translateY) / scale;
            
            // Convert to 0-1 range
            const x = originalX / rect.width;
            const y = originalY / rect.height;
            
            const clickedWaypoint = atlasWaypoints.findIndex(wp => {
                return Math.abs(wp.x - x) < 0.03 && Math.abs(wp.y - y) < 0.03;
            });
            
            if (clickedWaypoint >= 0) {
                if (removeWaypointMode) {
                    if (confirm('Delete this waypoint?')) {
                        atlasWaypoints.splice(clickedWaypoint, 1);
                        saveAtlasData();
                        renderWaypoints();
                    }
                } else if (waypointMode) {
                    openWaypointEdit(clickedWaypoint);
                }
            } else if (waypointMode) {
                atlasWaypoints.push({ x, y, title: '', description: '' });
                saveAtlasData();
                renderWaypoints();
                openWaypointEdit(atlasWaypoints.length - 1);
            }
        }
        
        function handleAtlasMouseMove(event) {
            // Handle waypoint dragging
            if (draggingWaypoint && draggingWaypointIndex !== null) {
                const container = document.getElementById('atlas-map-container');
                const viewport = document.getElementById('atlas-map-viewport');
                const rect = container.getBoundingClientRect();
                
                // Get the current transform values
                const transform = viewport.style.transform;
                let translateX = 0, translateY = 0, scale = atlasZoom;
                
                if (transform) {
                    const translateMatch = transform.match(/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/);
                    const scaleMatch = transform.match(/scale\(([-\d.]+)\)/);
                    if (translateMatch) {
                        translateX = parseFloat(translateMatch[1]);
                        translateY = parseFloat(translateMatch[2]);
                    }
                    if (scaleMatch) {
                        scale = parseFloat(scaleMatch[1]);
                    }
                }
                
                // Calculate mouse position accounting for zoom and pan
                const mouseX = event.clientX - rect.left;
                const mouseY = event.clientY - rect.top;
                
                // Reverse the transform to get original coordinates
                const originalX = (mouseX - translateX) / scale;
                const originalY = (mouseY - translateY) / scale;
                
                // Convert to 0-1 range and clamp
                const x = Math.max(0, Math.min(1, originalX / rect.width));
                const y = Math.max(0, Math.min(1, originalY / rect.height));
                
                // Update waypoint position
                atlasWaypoints[draggingWaypointIndex].x = x;
                atlasWaypoints[draggingWaypointIndex].y = y;
                
                // Re-render waypoints
                renderWaypoints();
                return;
            }
            
            // Handle map dragging (when zoomed)
            if (atlasDragging && atlasZoom > 1) {
                const viewport = document.getElementById('atlas-map-viewport');
                const match = viewport.style.transform.match(/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/);
                let currentX = match ? parseFloat(match[1]) : 0;
                let currentY = match ? parseFloat(match[2]) : 0;
                
                const dx = event.clientX - atlasDragStart.x;
                const dy = event.clientY - atlasDragStart.y;
                
                viewport.style.transform = `translate(${currentX + dx}px, ${currentY + dy}px) scale(${atlasZoom})`;
                atlasDragStart = { x: event.clientX, y: event.clientY };
                return;
            }
            
            // Waypoint hover tooltip
            const container = document.getElementById('atlas-map-container');
            const viewport = document.getElementById('atlas-map-viewport');
            const rect = container.getBoundingClientRect();
            
            // Get the current transform values
            const transform = viewport.style.transform;
            let translateX = 0, translateY = 0, scale = atlasZoom;
            
            if (transform) {
                const translateMatch = transform.match(/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/);
                const scaleMatch = transform.match(/scale\(([-\d.]+)\)/);
                if (translateMatch) {
                    translateX = parseFloat(translateMatch[1]);
                    translateY = parseFloat(translateMatch[2]);
                }
                if (scaleMatch) {
                    scale = parseFloat(scaleMatch[1]);
                }
            }
            
            // Calculate mouse position accounting for zoom and pan
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;
            
            // Reverse the transform to get original coordinates
            const originalX = (mouseX - translateX) / scale;
            const originalY = (mouseY - translateY) / scale;
            
            // Convert to 0-1 range
            const x = originalX / rect.width;
            const y = originalY / rect.height;
            
            const hovered = atlasWaypoints.findIndex(wp => Math.abs(wp.x - x) < 0.03 && Math.abs(wp.y - y) < 0.03);
            const tooltip = document.getElementById('waypoint-hover-tooltip');
            
            if (hovered >= 0 && !draggingWaypoint) {
                const wp = atlasWaypoints[hovered];
                document.getElementById('waypoint-hover-title').textContent = wp.title || 'Untitled Waypoint';
                document.getElementById('waypoint-hover-coords').textContent = `(${Math.round(wp.x * 600)}, ${Math.round(wp.y * 600)})`;
                tooltip.style.left = event.clientX + 15 + 'px';
                tooltip.style.top = event.clientY + 15 + 'px';
                tooltip.classList.add('active');
            } else {
                tooltip.classList.remove('active');
            }
        }
        
        function handleAtlasMouseDown(event) {
            // Handle waypoint dragging in move mode
            if (moveWaypointMode) {
                const container = document.getElementById('atlas-map-container');
                const viewport = document.getElementById('atlas-map-viewport');
                const rect = container.getBoundingClientRect();
                
                // Get the current transform values
                const transform = viewport.style.transform;
                let translateX = 0, translateY = 0, scale = atlasZoom;
                
                if (transform) {
                    const translateMatch = transform.match(/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/);
                    const scaleMatch = transform.match(/scale\(([-\d.]+)\)/);
                    if (translateMatch) {
                        translateX = parseFloat(translateMatch[1]);
                        translateY = parseFloat(translateMatch[2]);
                    }
                    if (scaleMatch) {
                        scale = parseFloat(scaleMatch[1]);
                    }
                }
                
                // Calculate click position accounting for zoom and pan
                const clickX = event.clientX - rect.left;
                const clickY = event.clientY - rect.top;
                
                // Reverse the transform to get original coordinates
                const originalX = (clickX - translateX) / scale;
                const originalY = (clickY - translateY) / scale;
                
                // Convert to 0-1 range
                const x = originalX / rect.width;
                const y = originalY / rect.height;
                
                const clickedWaypoint = atlasWaypoints.findIndex(wp => {
                    return Math.abs(wp.x - x) < 0.03 && Math.abs(wp.y - y) < 0.03;
                });
                
                if (clickedWaypoint >= 0) {
                    draggingWaypoint = true;
                    draggingWaypointIndex = clickedWaypoint;
                    
                    // Add dragging class for pulse animation
                    setTimeout(() => {
                        const waypoints = document.querySelectorAll('.atlas-waypoint');
                        if (waypoints[clickedWaypoint]) {
                            waypoints[clickedWaypoint].classList.add('dragging');
                        }
                    }, 0);
                }
                return;
            }
            
            if (waypointMode || removeWaypointMode || atlasZoom <= 1) return;
            atlasDragging = true;
            atlasDragStart = { x: event.clientX, y: event.clientY };
            document.getElementById('atlas-map-container').style.cursor = 'grabbing';
        }
        
        function handleAtlasMouseUp() {
            // Handle waypoint drop
            if (draggingWaypoint) {
                draggingWaypoint = false;
                draggingWaypointIndex = null;
                
                // Remove dragging class
                document.querySelectorAll('.atlas-waypoint').forEach(wp => {
                    wp.classList.remove('dragging');
                });
                
                // Save the new position
                saveAtlasData();
                return;
            }
            
            atlasDragging = false;
            const container = document.getElementById('atlas-map-container');
            if (atlasZoom > 1) container.style.cursor = 'grab';
        }
        
        function handleAtlasZoom(event) {
            if (waypointMode || moveWaypointMode || removeWaypointMode) {
                // Show warning tooltip
                event.preventDefault();
                const tooltip = document.getElementById('zoom-warning-tooltip');
                tooltip.style.left = event.clientX + 15 + 'px';
                tooltip.style.top = event.clientY + 15 + 'px';
                tooltip.classList.add('show');
                
                // Auto-hide after 1 second
                setTimeout(() => {
                    tooltip.classList.remove('show');
                }, 1000);
                return;
            }
            event.preventDefault();
            
            const container = document.getElementById('atlas-map-container');
            const rect = container.getBoundingClientRect();
            const viewport = document.getElementById('atlas-map-viewport');
            
            const mouseXPx = event.clientX - rect.left;
            const mouseYPx = event.clientY - rect.top;
            
            const zoomDelta = event.deltaY > 0 ? 0.9 : 1.1;
            const newZoom = Math.max(1, Math.min(4, atlasZoom * zoomDelta));
            
            if (newZoom !== atlasZoom) {
                const match = viewport.style.transform.match(/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/);
                let currentX = match ? parseFloat(match[1]) : 0;
                let currentY = match ? parseFloat(match[2]) : 0;
                
                const pointX = (mouseXPx - currentX) / atlasZoom;
                const pointY = (mouseYPx - currentY) / atlasZoom;
                
                const newX = mouseXPx - pointX * newZoom;
                const newY = mouseYPx - pointY * newZoom;
                
                atlasZoom = newZoom;
                viewport.style.transformOrigin = '0 0';
                viewport.style.transform = `translate(${newX}px, ${newY}px) scale(${atlasZoom})`;
                
                container.classList.toggle('zoomed', atlasZoom > 1);
                container.style.cursor = atlasZoom > 1 ? 'grab' : 'zoom-in';
            }
        }
        
        function resetAtlasView() {
            atlasZoom = 1;
            const viewport = document.getElementById('atlas-map-viewport');
            viewport.style.transform = '';
            document.getElementById('atlas-map-container').classList.remove('zoomed');
        }
        
        function renderWaypoints() {
            const container = document.getElementById('atlas-waypoints-container');
            container.innerHTML = '';
            
            atlasWaypoints.forEach((wp) => {
                const marker = document.createElement('div');
                marker.className = 'atlas-waypoint';
                marker.style.left = (wp.x * 100) + '%';
                marker.style.top = (wp.y * 100) + '%';
                container.appendChild(marker);
            });
        }
        
        function openWaypointEdit(index) {
            editingWaypointIndex = index;
            const waypoint = atlasWaypoints[index];
            
            document.getElementById('waypoint-title-input').value = waypoint.title || '';
            document.getElementById('waypoint-desc-input').value = waypoint.description || '';
            updateWaypointCharCount();
            
            document.getElementById('waypoint-edit-overlay').classList.add('active');
        }
        
        function closeWaypointEdit(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('waypoint-edit-overlay').classList.remove('active');
            editingWaypointIndex = null;
        }
        
        function saveWaypointDetails() {
            if (editingWaypointIndex === null) return;
            
            atlasWaypoints[editingWaypointIndex].title = document.getElementById('waypoint-title-input').value;
            atlasWaypoints[editingWaypointIndex].description = document.getElementById('waypoint-desc-input').value;
            
            saveAtlasData();
            renderWaypoints();
            closeWaypointEdit();
        }
        
        function updateWaypointCharCount() {
            const desc = document.getElementById('waypoint-desc-input').value;
            document.getElementById('waypoint-char-count').textContent = `${desc.length} / 150`;
        }
        
        function handleAtlasTitleInput(input) {
            input.classList.toggle('overflow', input.value.length > 40);
            atlasTitle = input.value || "World Atlas";
            saveAtlasData();
        }
        
        function toggleGridControl() {
            waypointMode = false;
            moveWaypointMode = false;
            removeWaypointMode = false;
            updateWaypointModeUI();
            
            const control = document.getElementById('atlas-grid-control');
            const btn = document.getElementById('grid-scale-btn');
            control.classList.toggle('active');
            btn.classList.toggle('active');
        }
        
        function updateGridSliderUI() {
            const fillPercent = (atlasGridScale / 64) * 100;
            document.getElementById('atlas-grid-slider-fill').style.width = fillPercent + '%';
            document.getElementById('atlas-grid-value').textContent = atlasGridScale;
        }
        
        function startGridSlider(event) {
            event.preventDefault();
            const slider = document.getElementById('atlas-grid-slider');
            const rect = slider.getBoundingClientRect();
            
            function updateSlider(e) {
                const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                atlasGridScale = Math.round((x / rect.width) * 64);
                updateGridSliderUI();
                updateAtlasGrid();
                saveAtlasData();
            }
            
            function stopSlider() {
                document.removeEventListener('mousemove', updateSlider);
                document.removeEventListener('mouseup', stopSlider);
            }
            
            updateSlider(event);
            document.addEventListener('mousemove', updateSlider);
            document.addEventListener('mouseup', stopSlider);
        }
        
        function updateAtlasGrid() {
            const overlay = document.getElementById('atlas-grid-overlay');
            overlay.innerHTML = '';
            
            if (atlasGridScale === 0) return;
            
            for (let i = 1; i <= atlasGridScale; i++) {
                const vLine = document.createElement('div');
                vLine.className = 'atlas-grid-line vertical';
                vLine.style.left = ((i / (atlasGridScale + 1)) * 100) + '%';
                overlay.appendChild(vLine);
                
                const hLine = document.createElement('div');
                hLine.className = 'atlas-grid-line horizontal';
                hLine.style.top = ((i / (atlasGridScale + 1)) * 100) + '%';
                overlay.appendChild(hLine);
            }
        }

        // Initialize
        async function init() {
            await initImageDB();
            await loadAtlasData();
        }
        
        init();
        
        // Escape key handling
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('waypoint-edit-overlay').classList.contains('active')) {
                    closeWaypointEdit();
                } else if (document.getElementById('upload-menu-overlay').classList.contains('active')) {
                    closeUploadMenu();
                } else {
                    closeAtlas();
                }
            }
        });
    </script>
</body>
</html>