<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLine | Creation Plane</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;800&display=swap');

        :root {
            --bg-color: #0c0c0c;
            --accent: #222;
            --text: #ffffff;
            --text-dim: #555;
            --ui-speed: 0.6s cubic-bezier(0.8, 0, 0.2, 1);
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: #000; color: var(--text); 
            font-family: 'Inter', sans-serif; overflow: hidden; 
        }

        /* --- Loading Overlay --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease;
        }
        .loader-content { text-align: center; width: 280px; }
        .progress-track { width: 100%; height: 2px; background: #111; margin-top: 20px; }
        .progress-bar { width: 0%; height: 100%; background: #fff; transition: width 2.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- Dynamic UI Bars --- */
        .ui-bar {
            position: fixed; left: 0; width: 100%;
            background: rgba(12, 12, 12, 0.9); backdrop-filter: blur(15px);
            z-index: 1000; transition: transform var(--ui-speed), opacity var(--ui-speed);
            display: flex; align-items: center; box-sizing: border-box;
            border: 1px solid var(--accent);
        }
        .top-nav { top: 0; height: 80px; padding: 0 2rem; justify-content: space-between; border-width: 0 0 1px 0; }
        .bottom-nav { bottom: 0; height: 45px; padding: 0 2rem; justify-content: space-between; border-width: 1px 0 0 0; }

        .is-panning .ui-bar { transform: translateY(-100%); opacity: 0; }
        .is-panning .bottom-nav { transform: translateY(100%); }

        /* Typography Matching Index.html */
        .brand-block { display: flex; flex-direction: column; line-height: 1; }
        .brand-main { font-weight: 800; letter-spacing: 4px; font-size: 1.2rem; }
        .brand-sub { color: var(--text-dim); font-weight: 300; letter-spacing: 2px; font-size: 0.7rem; margin-top: 4px; }
        .back-arrow { cursor: pointer; font-size: 1.2rem; margin-top: 8px; transition: 0.3s; width: fit-content; }
        .back-arrow:hover { color: #888; transform: translateX(-3px); }

        .universe-title { position: absolute; left: 50%; transform: translateX(-50%); text-transform: uppercase; font-weight: 300; letter-spacing: 5px; font-size: 0.8rem; }

        /* --- Compact Tool Dock --- */
        .tool-dock {
            position: fixed; left: 20px; top: 50%; transform: translateY(-50%);
            width: 50px; background: #0c0c0c; border: 1px solid var(--accent);
            border-radius: 30px; padding: 20px 0;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            z-index: 1100; transition: opacity 0.3s;
        }
        .is-panning .tool-dock { opacity: 0.2; pointer-events: none; }

        /* --- Infinite Canvas --- */
        #viewport { width: 100vw; height: 100vh; cursor: grab; background: #050505; }
        #viewport:active { cursor: grabbing; }
        #world { 
            position: absolute; width: 10000px; height: 10000px; 
            background-image: radial-gradient(var(--accent) 1px, transparent 1px);
            background-size: 60px 60px;
            transform-origin: 0 0;
        }

        /* --- Modular Nodes --- */
        .node {
            position: absolute; background: #121212; border: 1px solid var(--accent);
            border-radius: 4px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; min-width: 200px;
        }
        .handle { height: 10px; background: #1a1a1a; cursor: grab; border-radius: 4px 4px 0 0; }
        .node-content { padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        input, textarea { 
            background: #000; border: 1px solid #222; color: #fff; 
            font-family: inherit; font-size: 0.8rem; padding: 8px; outline: none;
        }

        .tool-item { width: 35px; height: 35px; border: 1px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #111; cursor: grab; font-weight: 800; font-size: 0.7rem; transition: 0.2s; }
        .tool-item:hover { background: #fff; color: #000; }

        #cursor-tooltip { position: fixed; pointer-events: none; background: #fff; color: #000; padding: 4px 8px; font-size: 0.6rem; font-weight: 800; border-radius: 2px; z-index: 5000; display: none; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="cursor-tooltip"></div>

    <div id="loader">
        <div class="loader-content">
            <div id="loader-msg" style="font-size: 0.6rem; letter-spacing: 3px; color: #444; text-transform: uppercase;">Entering Plane</div>
            <div class="progress-track"><div id="progress-bar" class="progress-bar"></div></div>
        </div>
    </div>

    <nav class="ui-bar top-nav">
        <div class="brand-block">
            <div class="brand-main">ALPHALINE <span style="font-weight:300; color:#333;">| CREATION PLANE</span></div>
            <div class="back-arrow" onclick="triggerExitSequence()">←</div>
        </div>
        <div class="universe-title" id="active-name">---</div>
    </nav>

    <footer class="ui-bar bottom-nav">
        <div style="letter-spacing: 1px;">© 2026 ALPHALINE SYSTEMS</div>
        <div id="coord-display">COORD: 0, 0</div>
    </footer>

    <aside class="tool-dock">
        <div class="tool-item" draggable="true" ondragstart="e => e.dataTransfer.setData('type','container')" onmouseenter="tip('Container')" onmouseleave="untip()">C</div>
        <div class="tool-item" draggable="true" ondragstart="e => e.dataTransfer.setData('type','text')" onmouseenter="tip('Text Node')" onmouseleave="untip()">T</div>
        <div class="tool-item" draggable="true" ondragstart="e => e.dataTransfer.setData('type','image')" onmouseenter="tip('Image Node')" onmouseleave="untip()">I</div>
    </aside>

    <div id="viewport">
        <div id="world"></div>
    </div>

    <script>
        const world = document.getElementById('world');
        const viewport = document.getElementById('viewport');
        const params = new URLSearchParams(window.location.search);
        const universeId = params.get('id');
        let universes = JSON.parse(localStorage.getItem('alphaline_universes') || "[]");
        let activeUniverse = universes.find(u => u.id == universeId);

        let worldPos = activeUniverse?.camera || { x: -4500, y: -4500 };

        // --- Loading Sequence ---
        window.onload = () => {
            if (activeUniverse) document.getElementById('active-name').innerText = activeUniverse.name;
            
            const bar = document.getElementById('progress-bar');
            setTimeout(() => {
                bar.style.width = '100%';
                // Signal shell to retract immediately
                window.parent.postMessage('RETRACT_FRAME', '*');
            }, 100);

            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    initWorkspace();
                }, 1000);
            }, 3500); // 3.5s total delay as requested
        };

        function initWorkspace() {
            world.style.transform = `translate(${worldPos.x}px, ${worldPos.y}px)`;
            if (activeUniverse?.timeline) {
                activeUniverse.timeline.forEach(data => createNode(data));
            }
        }

        // --- Panning Engine (Moves the world) ---
        let isPanning = false, startX, startY;
        viewport.onmousedown = (e) => {
            if (e.target !== viewport && e.target !== world) return;
            isPanning = true;
            document.body.classList.add('is-panning');
            startX = e.clientX - worldPos.x;
            startY = e.clientY - worldPos.y;
        };
        window.onmousemove = (e) => {
            if (isPanning) {
                worldPos.x = e.clientX - startX;
                worldPos.y = e.clientY - startY;
                world.style.transform = `translate(${worldPos.x}px, ${worldPos.y}px)`;
                document.getElementById('coord-display').innerText = `COORD: ${Math.round(-worldPos.x)}, ${Math.round(-worldPos.y)}`;
            }
        };
        window.onmouseup = () => { 
            isPanning = false; 
            document.body.classList.remove('is-panning');
            syncData();
        };

        // --- Node Logic ---
        viewport.ondragover = e => e.preventDefault();
        viewport.ondrop = e => {
            const type = e.dataTransfer.getData('type') || 'text';
            const x = e.clientX - worldPos.x - 100;
            const y = e.clientY - worldPos.y - 20;
            createNode({ type, x, y });
            syncData();
        };

        function createNode(data) {
            const node = document.createElement('div');
            node.className = `node node-${data.type}`;
            node.style.left = data.x + 'px';
            node.style.top = data.y + 'px';
            node.dataset.id = data.boxId || 'box_' + Date.now();

            node.innerHTML = `
                <div class="handle"></div>
                <div class="node-content">
                    <input class="node-title" placeholder="Title" value="${data.title || ''}" oninput="syncData()">
                    ${data.type === 'text' ? `<textarea placeholder="Body Content" oninput="syncData()">${data.body || ''}</textarea>` : ''}
                    ${data.type === 'image' ? `<input placeholder="Image URL" value="${data.url || ''}" oninput="syncData()">` : ''}
                    ${data.type === 'container' ? `<div style="height:100px; border:1px dashed #333; display:flex; align-items:center; justify-content:center; font-size:0.5rem; color:#333;">QUADRANT DROP ZONE</div>` : ''}
                </div>
            `;
            world.appendChild(node);
            makeDraggable(node);
        }

        function makeDraggable(el) {
            const handle = el.querySelector('.handle');
            handle.onmousedown = (e) => {
                e.stopPropagation();
                let p3 = e.clientX, p4 = e.clientY;
                document.onmousemove = (e) => {
                    let p1 = p3 - e.clientX, p2 = p4 - e.clientY;
                    p3 = e.clientX; p4 = e.clientY;
                    el.style.top = (el.offsetTop - p2) + "px";
                    el.style.left = (el.offsetLeft - p1) + "px";
                };
                document.onmouseup = () => { document.onmousemove = null; syncData(); };
            };
        }

        // --- Exit Sequence ---
        function triggerExitSequence() {
            syncData();
            const loader = document.getElementById('loader');
            const bar = document.getElementById('progress-bar');
            document.getElementById('loader-msg').innerText = "Returning to Archive";
            bar.style.width = '0%';
            loader.style.display = 'flex';
            loader.style.opacity = '1';
            
            setTimeout(() => bar.style.width = '100%', 50);
            setTimeout(() => {
                window.parent.postMessage('RESTORE_FRAME', '*');
                window.location.href = 'universes.html';
            }, 2000);
        }

        function syncData() {
            const blocks = document.querySelectorAll('.node');
            activeUniverse.timeline = Array.from(blocks).map(b => ({
                boxId: b.dataset.id,
                type: b.classList.contains('node-text') ? 'text' : b.classList.contains('node-image') ? 'image' : 'container',
                x: parseInt(b.style.left),
                y: parseInt(b.style.top),
                title: b.querySelector('.node-title').value,
                body: b.querySelector('textarea')?.value || "",
                url: b.querySelector('input:nth-child(2)')?.value || ""
            }));
            activeUniverse.camera = worldPos;
            const idx = universes.findIndex(u => u.id == universeId);
            universes[idx] = activeUniverse;
            localStorage.setItem('alphaline_universes', JSON.stringify(universes));
        }

        // --- Tooltip ---
        const tooltip = document.getElementById('cursor-tooltip');
        function tip(t) { tooltip.innerText = t; tooltip.style.display = 'block'; }
        function untip() { tooltip.style.display = 'none'; }
        window.onmousemove = (e) => {
            if(tooltip.style.display === 'block') {
                tooltip.style.left = e.clientX + 15 + 'px';
                tooltip.style.top = e.clientY + 15 + 'px';
            }
        };
    </script>
</body>
</html>
