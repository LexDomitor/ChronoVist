<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLine | Workspace</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@300&display=swap');
        
        :root { 
            --bg: #000; 
            --ui-bg: #080808; 
            --text-dim: #666; 
            --accent: #fff; 
            --danger: #ff4444; 
            --border: #222;
        }
        
        html, body { 
            margin: 0; padding: 0; height: 100vh; width: 100vw; 
            background: var(--bg); color: #fff; 
            font-family: 'Inter', sans-serif; overflow: hidden;
            user-select: none;
        }

        /* --- HEADER --- */
        .workspace-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 65px;
            background: var(--ui-bg); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 2rem; box-sizing: border-box; z-index: 2000;
        }
        .brand-block { display: flex; align-items: center; gap: 15px; }
        .back-btn { cursor: pointer; color: var(--text-dim); font-size: 1.2rem; transition: 0.2s; width: 30px; text-align: center; }
        .back-btn:hover { color: #fff; }
        .nav-text { font-size: 0.7rem; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); display:flex; gap:10px; }
        .nav-text strong { color: #fff; font-weight: 800; }
        .title-sep { color: #333; }
        
        .status-block { margin-left: auto; display: flex; align-items: center; gap: 30px; text-align: right; }
        .save-indicator { font-size: 0.6rem; color: #444; letter-spacing: 1px; font-weight: 600; }
        .clock-block { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-dim); line-height: 1.3; }

        /* --- MODALS & LIGHTBOX --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 3000;
        }
        .modal-content { background: #080808; border: 1px solid #333; padding: 30px; width: 300px; text-align: center; display:flex; flex-direction:column; gap:20px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .modal-input { background: #111; border: 1px solid #333; color: #fff; padding: 10px; font-family: 'JetBrains Mono'; text-align: center; outline: none; font-size: 1.2rem; }
        
        /* Lightbox specific */
        #lightbox-img-container { display: flex; flex-direction: column; align-items: center; gap: 20px; max-width: 90vw; max-height: 90vh; }
        #lightbox-img { max-width: 100%; max-height: 80vh; border: 1px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.8); object-fit: contain; }
        .lightbox-controls { display: flex; gap: 15px; }

        /* --- TRASH ZONE --- */
        #trash-zone {
            position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px;
            border: 2px dashed #444; border-radius: 50%; color: #444;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; z-index: 2500; transition: 0.3s;
            opacity: 0; pointer-events: none; background: rgba(0,0,0,0.5);
        }
        body.global-dragging #trash-zone { opacity: 1; pointer-events: all; }
        #trash-zone.drag-over { border-color: var(--danger); color: var(--danger); background: rgba(255, 68, 68, 0.1); transform: scale(1.1); }

        /* --- PLANE & GRID --- */
        #plane-container { 
            width: 100vw; height: calc(100vh - 65px); margin-top: 65px;
            background-color: #000;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px; position: relative; overflow: hidden; cursor: crosshair;
        }
        #node-group {
            position: absolute; left: 50%; top: 50%; display: none; flex-direction: column; align-items: center; transform-origin: center; z-index: 100;
        }

        /* --- NODES --- */
        .grid-node { padding: 20px 40px; background: rgba(15, 15, 15, 0.75); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); display: flex; flex-direction: column; align-items: center; }
        .grid-node h2 { font-family: 'JetBrains Mono'; font-size: 2.5rem; margin: 0; letter-spacing: 6px; font-weight: 300; }
        .node-label { font-size: 0.5rem; color: #888; letter-spacing: 4px; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; }
        
        .sub-node { padding: 15px 30px; background: rgba(10, 10, 10, 0.6); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50px; text-align: center; min-width: 150px; }

        .synopsis-node { width: 400px; background: rgba(20, 20, 20, 0.9); border: 1px solid #333; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .synopsis-input { width: 100%; background: transparent; border: none; color: #ddd; font-family: 'Inter', sans-serif; font-size: 0.8rem; line-height: 1.5; resize: none; outline: none; text-align: center; overflow: hidden; }

        /* Pipes */
        .node-pipe { width: 1px; height: 40px; background: rgba(255,255,255,0.2); position: relative; display: flex; justify-content: center; align-items: center; }
        .pipe-add { position: absolute; width: 22px; height: 22px; border-radius: 50%; background: #000; border: 1px solid #555; color: #fff; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: 0.2s; z-index: 10; transform: scale(0.8); }
        .node-pipe:hover .pipe-add, .branch-hub:hover .pipe-add { opacity: 1; transform: scale(1); }

        /* Branch Hub */
        .branch-hub { display: flex; align-items: center; justify-content: center; position: relative; height: 40px; width: 100%; }
        .hub-center-line { width: 1px; height: 100%; background: rgba(255,255,255,0.2); position: relative; display:flex; justify-content:center; align-items:center; }
        .hub-arm { width: 0px; height: 1px; background: rgba(255,255,255,0.2); transition: 0.3s; position: relative; }
        .hub-trigger { 
            width: 20px; height: 20px; border-radius: 50%; background: #000; border: 1px solid #555; color: #fff; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; 
            position: absolute; top: 50%; transform: translateY(-50%); opacity: 0; transition:0.2s;
        }
        .branch-hub.active .hub-arm { width: 300px; }
        .branch-hub.active .hub-trigger { opacity: 1; }
        .trigger-left { left: 0; transform: translate(-50%, -50%); }
        .trigger-right { right: 0; transform: translate(50%, -50%); }

        /* --- PLOT COLUMNS (Updated for Expansion) --- */
        #plot-grid-container {
            display: flex; align-items: flex-start; gap: 40px; justify-content: center;
            width: max-content; min-width: 100%;
        }
        
        .plot-column { 
            display: flex; flex-direction: column; 
            min-width: 400px; 
            width: auto; /* Dynamic width */
            transition: all 0.3s; 
        }

        /* Pivot Logic */
        #col-left { align-items: flex-end; }  /* Expands to the left */
        #col-right { align-items: flex-start; } /* Expands to the right */
        #col-main { align-items: center; } /* Expands from center */

        .side-column { opacity: 0.8; transform: scale(0.95); transform-origin: top center; }
        .side-column:hover { opacity: 1; }

        /* --- PLOT & EVENT NODES --- */
        .plot-node-wrapper { display: flex; flex-direction: column; align-items: center; width: auto; margin-bottom: 0px; }
        
        .plot-node {
            /* Dynamic sizing based on content */
            width: max-content; 
            min-width: 400px;
            max-width: 1200px; /* Safety cap */
            background: rgba(12, 12, 12, 0.85); border: 1px solid #333; border-radius: 15px; padding: 25px; 
            box-sizing: border-box; display: flex; flex-direction: column; gap: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .plot-title-field {
            background: transparent; border: none; border-bottom: 1px solid #222; color: #fff; font-size: 0.9rem; letter-spacing: 3px; text-transform: uppercase;
            padding-bottom: 8px; outline: none; width: 100%; font-family: 'JetBrains Mono'; text-align: center;
        }
        
        .event-node {
            display: flex; flex-direction: row; background: rgba(0,0,0,0.3); border: 1px solid #222; border-radius: 12px; overflow: hidden; transition: 0.2s;
            min-height: 100px; position: relative;
            /* Width fits content inside plot-node */
        }
        .event-node.flipped { flex-direction: row-reverse; }
        
        .event-text-container { flex: 1; min-width: 250px; padding: 15px 20px; position: relative; display: flex; flex-direction: column; }
        .event-input {
            background: transparent; border: none; color: #ddd; resize: none; width: 100%; font-size: 0.85rem; line-height: 1.6; outline: none;
            font-family: 'Inter', sans-serif; height: 100%; display: block; overflow: hidden;
        }
        .char-count { font-size: 0.5rem; color: #444; text-align: right; margin-top: 5px; font-family: 'JetBrains Mono'; }

        /* Dynamic Image Container */
        .event-image-container {
            /* Removed fixed width. Width is set by JS based on height. */
            height: auto;
            min-width: 140px; /* Minimum width */
            flex-shrink: 0; 
            background: #111; border-left: 1px solid #222; 
            cursor: pointer; overflow: hidden; display: flex; justify-content: center; align-items: center;
            transition: width 0.1s ease; /* Smooth expansion */
        }
        .event-node.flipped .event-image-container { border-left: none; border-right: 1px solid #222; }
        .event-image-container img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .event-image-container:hover img { transform: scale(1.05); opacity: 0.8; }
        .img-placeholder { padding: 10px; font-size: 0.5rem; color: #444; letter-spacing: 1px; text-align: center; }

        .event-tools {
            position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; opacity: 0; transition: 0.2s;
            background: rgba(0,0,0,0.8); padding: 2px 4px; border-radius: 4px;
        }
        .event-node:hover .event-tools { opacity: 1; }
        .tool-btn {
            cursor: pointer; font-size: 10px; color: #666; width: 16px; height: 16px; 
            display: flex; align-items: center; justify-content: center; border-radius: 3px;
        }
        .tool-btn:hover { color: #fff; background: #333; }
        .tool-delete:hover { color: var(--danger); background: rgba(255, 68, 68, 0.1); }

        /* Drag & Drop Styles */
        .draggable { cursor: grab; }
        .draggable:active { cursor: grabbing; }
        .dragging { opacity: 0.4; border: 1px dashed var(--accent) !important; }
        .drag-over { border: 1px solid var(--accent) !important; background: rgba(255,255,255,0.05); }

        /* --- TIMELINE HUD --- */
        #timeline-hud { position: fixed; left: 50%; top: 105px; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 1500; }
        #timeline-bar { width: 600px; height: 40px; background: rgba(8, 8, 8, 0.95); border: 1px solid var(--border); border-radius: 4px; position: relative; }
        .timeline-axis { position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: rgba(255, 255, 255, 0.1); transform: translateY(-50%); }
        .year-dot, .year-line { cursor: pointer; position: absolute; top: 50%; transform: translate(-50%, -50%); transition: 0.2s; }
        .year-dot { width: 12px; height: 12px; background: #333; border: 2px solid #000; border-radius: 50%; z-index: 20; }
        .year-line { width: 2px; height: 15px; background: #222; z-index: 10; }
        .selected-marker { background: var(--accent) !important; box-shadow: 0 0 15px var(--accent); height: 20px !important; width: 2px !important; }
        
        .year-box { position: absolute; background: #000; border: 1px solid #333; padding: 4px 8px; font-family: 'JetBrains Mono'; font-size: 0.6rem; color: #fff; pointer-events: none; }
        .box-min { right: 100%; margin-right: 15px; top: 50%; transform: translateY(-50%); }
        .box-max { left: 100%; margin-left: 15px; top: 50%; transform: translateY(-50%); }
        .box-above { bottom: 100%; margin-bottom: 10px; left: 50%; transform: translateX(-50%); opacity: 0; }
        .year-line:hover .box-above, .selected-marker .box-above { opacity: 1; }

        .tm-btn { background: #0a0a0a; border: 1px solid #222; color: #666; font-size: 0.55rem; padding: 8px 16px; text-transform: uppercase; cursor: pointer; transition: 0.2s; letter-spacing: 1px; }
        .tm-btn:hover { color: #fff; border-color: #555; }
        
        .add-circle {
            width: 40px; height: 40px; border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;
            color: #666; font-size: 1.2rem; transition: 0.3s; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); margin-top: 10px;
        }
        .add-circle:hover { border-color: #fff; color: #fff; transform: scale(1.1); }
    </style>
</head>
<body>

    <header class="workspace-header">
        <div class="brand-block">
            <div class="back-btn" onclick="exitWorkspace()">‚Üê</div>
            <div class="nav-text"><strong>ALPHALINE</strong> <span class="title-sep">|</span> CREATION PLANE <span class="title-sep">|</span> <span id="active-universe-name">LOADING...</span></div>
        </div>
        <div class="status-block">
            <div id="save-status" class="save-indicator">CHANGES SYNCED</div>
            <div id="workspace-clock" class="clock-block"></div>
        </div>
    </header>

    <div id="year-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">Temporal Coordinate</div>
            <input type="number" id="year-input" class="modal-input" placeholder="YYYY">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="tm-btn" onclick="closeYearModal()">Cancel</button>
                <button class="tm-btn" style="color:#fff; border-color:#fff;" onclick="confirmNewYear()">Initialize</button>
            </div>
        </div>
    </div>

    <div id="lightbox" class="modal-overlay" onclick="closeLightbox(event)">
        <div id="lightbox-img-container" onclick="event.stopPropagation()">
            <img id="lightbox-img" src="" alt="Event Media">
            <div class="lightbox-controls">
                <button class="tm-btn" style="color:var(--danger)" onclick="deleteLightboxImage()">Delete</button>
                <button class="tm-btn" onclick="replaceLightboxImage()">Replace</button>
                <button class="tm-btn" onclick="document.getElementById('lightbox').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <div id="trash-zone" title="Drop Plot here to delete">üóë</div>

    <div id="plane-container">
        <div id="node-group">
            <div class="grid-node">
                <div class="node-label">Temporal Reference</div>
                <h2 id="grid-year-display">0000</h2>
            </div>
            <div class="node-pipe"></div>
            
            <div class="sub-node">
                <div class="node-label">Associated Profiles</div>
                <div style="font-size: 0.5rem; color: #444;">LINK CHARACTERS</div>
            </div>
            <div class="node-pipe"></div>

            <div class="synopsis-node">
                <div class="node-label" style="margin-bottom:8px;">Synopsis</div>
                <textarea id="synopsis-text" class="synopsis-input" placeholder="Enter year synopsis..." oninput="handleSynopsis(this)"></textarea>
            </div>

            <div id="branch-hub" class="branch-hub">
                <div class="hub-arm">
                    <div class="hub-trigger trigger-left" onclick="addNewPlotNode(0, 'left')">+</div>
                </div>
                <div class="hub-center-line">
                    <div class="pipe-add" onclick="addNewPlotNode(0, 'main')">+</div>
                </div>
                <div class="hub-arm">
                    <div class="hub-trigger trigger-right" onclick="addNewPlotNode(0, 'right')">+</div>
                </div>
            </div>

            <div id="plot-grid-container">
                <div id="col-left" class="plot-column side-column"></div>
                <div id="col-main" class="plot-column"></div>
                <div id="col-right" class="plot-column side-column"></div>
            </div>
        </div>
        
        <div id="timeline-hud">
            <div id="timeline-bar"></div>
            <div style="display: flex; gap: 10px;">
                <button class="tm-btn" onclick="toggleDistribution()">Toggle Distribution</button>
                <button class="tm-btn" onclick="openYearModal()">+ Add Coordinate</button>
                <button id="delete-btn" class="tm-btn" style="color:var(--danger); display:none;" onclick="handleDeleteYear()">Delete Year</button>
            </div>
        </div>
    </div>

    <script>
        let currentUniverse = { years: [] };
        let plotsByYear = {}; 
        let selectedYear = null;
        let isDistributed = false;
        let panX = 0, panY = 0, gridZoom = 1;

        // Lightbox State
        let lbContext = { pIdx: null, eIdx: null, col: null };

        // Drag State
        let dragSrcEl = null;
        let dragType = null; 

        // Initialization
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const universes = JSON.parse(localStorage.getItem('alphaline_universes') || "[]");
            const active = universes.find(u => u.id == params.get('id'));
            const titleEl = document.getElementById('active-universe-name');
            
            if(active) {
                titleEl.innerText = active.name.toUpperCase();
            } else {
                titleEl.innerText = "UNNAMED";
            }
            updateClock();
        };

        function updateClock() {
            const now = new Date();
            const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            document.getElementById('workspace-clock').innerHTML = `SYSTEM TIME | ${now.toLocaleTimeString('en-GB', options)}<br>${now.toLocaleDateString().toUpperCase()}`;
        }
        setInterval(updateClock, 1000);

        function exitWorkspace() { 
            window.top.document.getElementById('content-frame').src = 'universes.html'; 
            window.top.document.body.classList.remove('workspace-mode'); 
        }

        // Camera Controls
        const plane = document.getElementById('plane-container');
        const nodeGroup = document.getElementById('node-group');

        plane.onmousedown = (e) => {
            if (e.target.closest('.plot-node') || e.target.closest('.modal-overlay') || e.target.closest('.event-node') || e.target.closest('.synopsis-node') || e.target.closest('#timeline-hud') || e.target.closest('.workspace-header')) return;
            let sx = e.clientX - panX, sy = e.clientY - panY;
            plane.onmousemove = (me) => {
                panX = me.clientX - sx; panY = me.clientY - sy;
                updateGrid();
            };
        };
        window.onmouseup = () => plane.onmousemove = null;
        
        plane.onwheel = (e) => {
            if (e.target.closest('#timeline-hud')) return;
            const delta = e.deltaY < 0 ? 1.1 : 0.9;
            gridZoom = Math.min(Math.max(0.1, gridZoom * delta), 3);
            updateGrid();
        };

        function updateGrid() {
            const b = 20 * gridZoom;
            plane.style.backgroundSize = `${b}px ${b}px`;
            plane.style.backgroundPosition = `${panX}px ${panY}px`;
            nodeGroup.style.transform = `translate(calc(-50% + ${panX}px), calc(-50% + ${panY}px)) scale(${gridZoom})`;
        }

        // Logic
        function ensureYearData(y) {
            if (!plotsByYear[y]) plotsByYear[y] = { synopsis: "", main: [], left: [], right: [] };
        }

        function handleSynopsis(el) {
            autoSize(el);
            if(selectedYear) plotsByYear[selectedYear].synopsis = el.value;
        }

        function addNewPlotNode(index, column) {
            if (!selectedYear) return;
            ensureYearData(selectedYear);
            plotsByYear[selectedYear][column].splice(index, 0, { title: 'NEW PLOT', events: [] });
            renderPlotStack();
        }

        function appendPlotNode(column) {
            if (!selectedYear) return;
            ensureYearData(selectedYear);
            plotsByYear[selectedYear][column].push({ title: 'NEW PLOT', events: [] });
            renderPlotStack();
        }

        function addEventToNode(pIdx, column) {
            plotsByYear[selectedYear][column][pIdx].events.push({ text: '', img: null, flipped: false });
            renderPlotStack();
        }

        function renderPlotStack() {
            const data = plotsByYear[selectedYear];
            if(!data) return;

            // Synopsis
            const synBox = document.getElementById('synopsis-text');
            synBox.value = data.synopsis || "";
            autoSize(synBox);

            // Hub Trigger
            const hub = document.getElementById('branch-hub');
            if(data.main.length > 0) hub.classList.add('active');
            else hub.classList.remove('active');

            renderColumn('col-left', data.left, 'left');
            renderColumn('col-main', data.main, 'main');
            renderColumn('col-right', data.right, 'right');
        }

        function renderColumn(containerId, plots, colName) {
            const stack = document.getElementById(containerId);
            stack.innerHTML = '';

            plots.forEach((plot, pIdx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'plot-node-wrapper draggable';
                wrapper.setAttribute('draggable', 'true');
                wrapper.dataset.index = pIdx;
                wrapper.dataset.col = colName;
                
                const node = document.createElement('div');
                node.className = 'plot-node';
                node.innerHTML = `
                    <input class="plot-title-field" value="${plot.title}" oninput="plotsByYear[selectedYear]['${colName}'][${pIdx}].title=this.value">
                    <div id="ev-container-${colName}-${pIdx}" style="display:flex; flex-direction:column; gap:12px;"></div>
                    <button class="tm-btn" style="border-radius:8px; border:1px dashed #333;" onclick="addEventToNode(${pIdx}, '${colName}')">+ Add Event</button>
                `;

                // Events
                const evCont = node.querySelector(`#ev-container-${colName}-${pIdx}`);
                plot.events.forEach((ev, eIdx) => {
                    const evNode = document.createElement('div');
                    evNode.className = `event-node draggable ${ev.flipped ? 'flipped' : ''}`;
                    evNode.setAttribute('draggable', 'true');
                    evNode.dataset.pIdx = pIdx;
                    evNode.dataset.eIdx = eIdx;
                    evNode.dataset.col = colName;
                    
                    evNode.innerHTML = `
                        <div class="event-text-container">
                            <div class="event-tools">
                                <div class="tool-btn" title="Flip Side" onclick="toggleEventSide(${pIdx}, ${eIdx}, '${colName}')">‚Üî</div>
                                <div class="tool-btn tool-delete" title="Delete Event" onclick="deleteEvent(${pIdx}, ${eIdx}, '${colName}')">√ó</div>
                            </div>
                            <textarea class="event-input" maxlength="2000" placeholder="Event description..." oninput="handleEventText(this, ${pIdx}, ${eIdx}, '${colName}')">${ev.text}</textarea>
                            <div class="char-count">${ev.text.length}/2000</div>
                        </div>
                        <div class="event-image-container" onclick="openLightbox(${pIdx}, ${eIdx}, '${colName}')">
                            ${ev.img ? `<img src="${ev.img}">` : '<span class="img-placeholder">ADD MEDIA</span>'}
                        </div>
                    `;
                    setupDnD(evNode, 'event');
                    evCont.appendChild(evNode);
                    // Init size
                    setTimeout(() => {
                        const txt = evNode.querySelector('textarea');
                        autoSize(txt);
                        adjustImageRatio(txt);
                    }, 0);
                });

                setupDnD(wrapper, 'plot');
                wrapper.appendChild(node);

                // Connector Pipe + Add Button
                const pipe = document.createElement('div');
                pipe.className = 'node-pipe';
                pipe.innerHTML = `<div class="pipe-add" onclick="addNewPlotNode(${pIdx + 1}, '${colName}')">+</div>`;
                wrapper.appendChild(pipe);
                
                stack.appendChild(wrapper);
            });

            // Trailing (+) for creating new node at the bottom of the column
            if(plots.length > 0) {
                 const trailingAdd = document.createElement('div');
                 trailingAdd.className = 'add-circle';
                 trailingAdd.style.marginTop = '20px';
                 trailingAdd.onclick = () => appendPlotNode(colName);
                 trailingAdd.innerText = '+';
                 stack.appendChild(trailingAdd);
            }
        }

        // --- ACTIONS ---
        function toggleEventSide(pIdx, eIdx, col) {
            const ev = plotsByYear[selectedYear][col][pIdx].events[eIdx];
            ev.flipped = !ev.flipped;
            renderPlotStack();
        }

        function deleteEvent(pIdx, eIdx, col) {
            if(confirm("Delete this event?")) {
                plotsByYear[selectedYear][col][pIdx].events.splice(eIdx, 1);
                renderPlotStack();
            }
        }

        // --- LIGHTBOX ---
        function openLightbox(pIdx, eIdx, col) {
            const ev = plotsByYear[selectedYear][col][pIdx].events[eIdx];
            if(!ev.img) {
                // Trigger upload if no image
                triggerImgUpload(pIdx, eIdx, col);
                return;
            }
            lbContext = { pIdx, eIdx, col };
            document.getElementById('lightbox-img').src = ev.img;
            document.getElementById('lightbox').style.display = 'flex';
        }

        function closeLightbox(e) {
            if(e.target.id === 'lightbox') document.getElementById('lightbox').style.display = 'none';
        }

        function deleteLightboxImage() {
            if(confirm("Remove image?")) {
                plotsByYear[selectedYear][lbContext.col][lbContext.pIdx].events[lbContext.eIdx].img = null;
                document.getElementById('lightbox').style.display = 'none';
                renderPlotStack();
            }
        }

        function replaceLightboxImage() {
            triggerImgUpload(lbContext.pIdx, lbContext.eIdx, lbContext.col);
            document.getElementById('lightbox').style.display = 'none';
        }

        function triggerImgUpload(pIdx, eIdx, col) {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = r => {
                    plotsByYear[selectedYear][col][pIdx].events[eIdx].img = r.target.result;
                    renderPlotStack();
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            input.click();
        }

        // --- DRAG & DROP & TRASH ---
        function setupDnD(el, type) {
            el.addEventListener('dragstart', (e) => {
                if(e.target.closest('.tool-btn')) return; 
                dragSrcEl = el;
                dragType = type;
                document.body.classList.add('global-dragging');
                el.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            el.addEventListener('dragover', (e) => {
                e.preventDefault();
                return false;
            });
            el.addEventListener('dragenter', () => el.classList.add('drag-over'));
            el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
            
            el.addEventListener('drop', (e) => {
                e.stopPropagation();
                if (dragSrcEl !== el && dragType === type) {
                    if (type === 'plot') {
                        movePlot(dragSrcEl.dataset.col, parseInt(dragSrcEl.dataset.index), el.dataset.col, parseInt(el.dataset.index));
                    } else if (dragSrcEl.dataset.col === el.dataset.col && dragSrcEl.dataset.pIdx === el.dataset.pIdx) {
                         reorderEvents(el.dataset.col, parseInt(dragSrcEl.dataset.pIdx), parseInt(dragSrcEl.dataset.eIdx), parseInt(el.dataset.pIdx), parseInt(el.dataset.eIdx));
                    }
                }
                return false;
            });
            el.addEventListener('dragend', () => {
                document.body.classList.remove('global-dragging');
                document.querySelectorAll('.draggable, #trash-zone').forEach(d => d.classList.remove('dragging', 'drag-over'));
                dragSrcEl = null; // Reset
            });
        }

        // GLOBAL TRASH LISTENERS (To Fix Loop)
        const trash = document.getElementById('trash-zone');
        trash.addEventListener('dragenter', () => trash.classList.add('drag-over'));
        trash.addEventListener('dragleave', () => trash.classList.remove('drag-over'));
        trash.addEventListener('dragover', (e) => e.preventDefault());
        trash.addEventListener('drop', (e) => {
            e.stopPropagation();
            trash.classList.remove('drag-over');
            
            if(dragType === 'plot' && dragSrcEl) {
                if(confirm("Delete this entire Plot Node and its events?")) {
                    const list = plotsByYear[selectedYear][dragSrcEl.dataset.col];
                    list.splice(dragSrcEl.dataset.index, 1);
                    renderPlotStack();
                }
            }
        });

        function movePlot(fromCol, fromIdx, toCol, toIdx) {
            const [moved] = plotsByYear[selectedYear][fromCol].splice(fromIdx, 1);
            plotsByYear[selectedYear][toCol].splice(toIdx, 0, moved);
            renderPlotStack();
        }

        function reorderEvents(col, fP, fE, tP, tE) {
            const list = plotsByYear[selectedYear][col][fP].events;
            const [moved] = list.splice(fE, 1);
            list.splice(tE, 0, moved);
            renderPlotStack();
        }

        // --- HELPERS ---
        function handleEventText(el, pIdx, eIdx, col) {
            autoSize(el);
            adjustImageRatio(el);
            plotsByYear[selectedYear][col][pIdx].events[eIdx].text = el.value;
            // Update counter
            el.nextElementSibling.innerText = `${el.value.length}/2000`;
        }

        function autoSize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        // NEW: Maintains 4:3 Aspect Ratio by adjusting image container width based on text height
        function adjustImageRatio(textArea) {
            const height = textArea.scrollHeight;
            const eventNode = textArea.closest('.event-node');
            const imgCont = eventNode.querySelector('.event-image-container');
            
            // 4:3 Aspect Ratio (Width = Height * 1.333)
            // If height is 100px, width should be 133px.
            const newWidth = Math.max(140, height * (4/3)); 
            imgCont.style.width = `${newWidth}px`;
        }

        // --- TIMELINE NAV ---
        function openYearModal() { document.getElementById('year-modal').style.display = 'flex'; }
        function closeYearModal() { document.getElementById('year-modal').style.display = 'none'; }
        
        function confirmNewYear() {
            const val = document.getElementById('year-input').value;
            if(!val) return;
            const y = parseInt(val);
            if(!plotsByYear[y]) {
                ensureYearData(y);
                selectedYear = y;
                renderPlotStack();
                document.getElementById('grid-year-display').innerText = y;
            } else {
                alert("Year already exists!");
            }
            closeYearModal();
        }

        function handleDeleteYear() {
            if(!selectedYear) return;
            if(confirm(`Delete year ${selectedYear} data?`)) {
                delete plotsByYear[selectedYear];
                selectedYear = null;
                document.getElementById('grid-year-display').innerText = "0000";
                // Clear grid
                document.getElementById('col-left').innerHTML = '';
                document.getElementById('col-main').innerHTML = '';
                document.getElementById('col-right').innerHTML = '';
                document.getElementById('synopsis-text').value = '';
            }
        }

        // Mock Init for visual test if localstorage empty
        if(!localStorage.getItem('alphaline_universes')) {
             selectedYear = 2026;
             document.getElementById('grid-year-display').innerText = "2026";
             ensureYearData(2026);
             plotsByYear[2026].main.push({title: 'Example Plot', events:[{text:'Type here to see expansion...', img:null, flipped:false}]});
             renderPlotStack();
        }

    </script>
</body>
</html>
