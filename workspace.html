<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLine | Workspace</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@300&display=swap');
        
        :root { 
            --bg: #000; 
            --ui-bg: #0d0d0d; 
            --text-primary: #fff;
            --text-dim: #999; 
            --accent: #fff; 
            --danger: #ff4444; 
            --border: #333;
            --grid-line: rgba(255, 255, 255, 0.08);
            --node-bg: rgba(15, 15, 15, 0.75);
            --node-border: rgba(255, 255, 255, 0.15);
            --panel-bg: rgba(12, 12, 12, 0.85);
            --hud-bg: #0a0a0a;
            --hud-text: #fff;
            --hud-border: #222;
            --pipe-color: rgba(255, 255, 255, 0.2);
        }

        /* Light Mode - Everything Light */
        body.theme-light {
            --bg: #f5f5f5;
            --ui-bg: #fff;
            --text-primary: #1a1a1a;
            --text-dim: #666;
            --border: #ddd;
            --grid-line: rgba(0, 0, 0, 0.06);
            --node-bg: rgba(255, 255, 255, 0.95);
            --node-border: rgba(0, 0, 0, 0.1);
            --panel-bg: rgba(255, 255, 255, 0.95);
            --hud-bg: #fff;
            --hud-text: #1a1a1a;
            --hud-border: #ddd;
            --pipe-color: rgba(0, 0, 0, 0.15);
        }

        /* Dark on Light - Light background, Dark nodes */
        body.theme-dark-on-light {
            --bg: #f5f5f5;
            --ui-bg: #fff;
            --text-primary: #fff;
            --text-dim: #999;
            --border: #ddd;
            --grid-line: rgba(0, 0, 0, 0.06);
            --node-bg: rgba(15, 15, 15, 0.85);
            --node-border: rgba(255, 255, 255, 0.15);
            --panel-bg: rgba(12, 12, 12, 0.85);
            --hud-bg: #0a0a0a;
            --hud-text: #fff;
            --hud-border: #222;
            --pipe-color: rgba(30, 30, 30, 0.4);
        }

        /* Light on Dark - Dark background, Light nodes */
        body.theme-light-on-dark {
            --bg: #000;
            --ui-bg: #0d0d0d;
            --text-primary: #1a1a1a;
            --text-dim: #666;
            --border: #333;
            --grid-line: rgba(255, 255, 255, 0.08);
            --node-bg: rgba(255, 255, 255, 0.95);
            --node-border: rgba(0, 0, 0, 0.1);
            --panel-bg: rgba(255, 255, 255, 0.95);
            --hud-bg: #fff;
            --hud-text: #1a1a1a;
            --hud-border: #ddd;
            --pipe-color: rgba(200, 200, 200, 0.4);
        }

        /* Apply colors to elements */
        body.theme-light #grid-year-display,
        body.theme-light .plot-title-field,
        body.theme-light .episode-title-input,
        body.theme-light .synopsis-input,
        body.theme-light .event-input,
        body.theme-light-on-dark #grid-year-display,
        body.theme-light-on-dark .plot-title-field,
        body.theme-light-on-dark .episode-title-input,
        body.theme-light-on-dark .synopsis-input,
        body.theme-light-on-dark .event-input {
            color: #1a1a1a;
        }

        body.theme-light .node-label,
        body.theme-light-on-dark .node-label {
            color: #555;
        }

        body.theme-light .episode-title-input::placeholder,
        body.theme-light .synopsis-input::placeholder,
        body.theme-light .event-input::placeholder,
        body.theme-light-on-dark .episode-title-input::placeholder,
        body.theme-light-on-dark .synopsis-input::placeholder,
        body.theme-light-on-dark .event-input::placeholder {
            color: #aaa;
        }

        body.theme-light .char-count,
        body.theme-light-on-dark .char-count {
            color: #999;
        }

        /* Light mode timeline dot shadows */
        body.theme-light .year-dot,
        body.theme-light-on-dark .year-dot {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
        }

        /* Light mode project name colors */
        body.theme-light #project-name-display,
        body.theme-light-on-dark #project-name-display {
            color: #888 !important;
        }

        body.theme-light #project-name-display span,
        body.theme-light-on-dark #project-name-display span {
            color: #555 !important;
        }
        
        html, body { 
            margin: 0; padding: 0; height: 100vh; width: 100vw; 
            background: var(--bg); color: #fff; 
            font-family: 'Inter', sans-serif; overflow: hidden;
            user-select: none;
        }

        /* --- HEADER --- */
        .workspace-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 65px;
            background: var(--hud-bg); 
            border-bottom: 1px solid var(--hud-border);
            display: flex; align-items: center; padding: 0 2rem; box-sizing: border-box; z-index: 2000;
        }
        .brand-block { display: flex; align-items: center; gap: 15px; }
        .back-btn { cursor: pointer; color: var(--text-dim); font-size: 1.2rem; transition: 0.2s; width: 30px; text-align: center; }
        .back-btn:hover { color: var(--hud-text); }
        .nav-text { font-size: 0.7rem; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); display:flex; gap:10px; align-items: center; }
        .nav-text strong { color: var(--hud-text); font-weight: 800; }
        
        .status-block { margin-left: auto; display: flex; align-items: center; gap: 30px; text-align: right; }
        .save-indicator { font-size: 0.6rem; color: #444; letter-spacing: 1px; font-weight: 600; }
        .clock-block { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-dim); line-height: 1.3; }

        /* --- MODALS & LIGHTBOX --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 3000;
        }
        .modal-content { 
            background: #080808; 
            border: 1px solid #333; 
            padding: 30px; 
            width: 300px; 
            text-align: center; 
            display:flex; 
            flex-direction:column; 
            gap:20px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); 
        }
        .modal-title {
            font-size: 0.65rem;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .modal-input { 
            background: #111; 
            border: 1px solid #333; 
            color: #fff; 
            padding: 10px; 
            font-family: 'JetBrains Mono'; 
            text-align: center; 
            outline: none; 
            font-size: 1.2rem; 
        }
        
        /* Lightbox specific */
        #lightbox-img-container { display: flex; flex-direction: column; align-items: center; gap: 20px; max-width: 90vw; max-height: 90vh; }
        #lightbox-img { max-width: 100%; max-height: 80vh; border: 1px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.8); object-fit: contain; }
        .lightbox-controls { display: flex; gap: 15px; }

        /* --- TRASH ZONE --- */
        #trash-zone {
            position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px;
            border: 2px dashed #444; border-radius: 50%; color: #444;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; z-index: 2500; transition: 0.3s;
            opacity: 0; pointer-events: none; background: rgba(0,0,0,0.5);
        }
        body.global-dragging #trash-zone { opacity: 1; pointer-events: all; }
        #trash-zone.drag-over { border-color: var(--danger); color: var(--danger); background: rgba(255, 68, 68, 0.1); transform: scale(1.1); }

        /* --- PLANE & GRID --- */
        #plane-container { 
            width: 100vw; height: calc(100vh - 65px); margin-top: 65px;
            background-color: var(--bg);
            background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 20px 20px; position: relative; overflow: hidden; cursor: crosshair;
        }
        #node-group {
            position: absolute; 
            left: 50%; 
            top: 50%; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            transform: translate(-50%, -50%);
            transform-origin: center center;
            z-index: 100;
        }

        /* --- NODES --- */
        .grid-node { 
            padding: 30px 60px; 
            background: var(--node-bg);
            backdrop-filter: blur(12px); 
            border: 2px solid var(--node-border);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .grid-node h2 { font-family: 'JetBrains Mono'; font-size: 3rem; margin: 0; letter-spacing: 6px; font-weight: 300; color: var(--text-primary); }
        .node-label { font-size: 0.55rem; color: #888; letter-spacing: 4px; font-weight: 800; margin-bottom: 8px; text-transform: uppercase; }
        
        .episode-title-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--border);
            color: var(--text-dim);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            text-align: center;
            outline: none;
            padding: 10px 30px;
            margin-top: 12px;
            width: 280px;
            transition: 0.2s;
        }

        .episode-title-input:focus {
            border-bottom-color: var(--text-dim);
            color: var(--text-primary);
        }

        .episode-title-input::placeholder {
            color: #444;
        }
        
        .sub-node { 
            padding: 20px 40px; 
            background: var(--node-bg);
            backdrop-filter: blur(8px); 
            border: 2px solid var(--node-border);
            border-radius: 50px; 
            text-align: center; 
            min-width: 200px; 
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sub-node:hover {
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2), 0 0 40px rgba(255, 255, 255, 0.1);
            background: rgba(15, 15, 15, 0.8);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .synopsis-node { 
            width: 500px; 
            background: var(--panel-bg);
            border: 2px solid var(--border);
            border-radius: 8px; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .synopsis-input { 
            width: 100%; 
            background: transparent; 
            border: none; 
            color: var(--text-primary);
            font-family: 'Inter', sans-serif; 
            font-size: 0.85rem; 
            line-height: 1.5; 
            resize: none; 
            outline: none; 
            text-align: center; 
            overflow: hidden; 
        }

        /* Pipes */
        .node-pipe { 
            width: 2px; 
            height: 40px; 
            background: var(--pipe-color);
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .pipe-add { 
            position: absolute; 
            width: 22px; 
            height: 22px; 
            border-radius: 50%; 
            background: var(--node-bg);
            border: 2px solid var(--node-border);
            color: var(--text-primary);
            font-size: 14px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            opacity: 0; 
            transition: 0.2s; 
            z-index: 10; 
            transform: scale(0.8); 
        }
        .node-pipe:hover .pipe-add, .branch-hub:hover .pipe-add { opacity: 1; transform: scale(1); }

        /* Branch Hub */
        .branch-hub { display: flex; align-items: center; justify-content: center; position: relative; height: 40px; width: 100%; }
        .hub-center-line { 
            width: 2px; 
            height: 100%; 
            background: var(--pipe-color);
            position: relative; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
        }
        .hub-arm { 
            width: 0px; 
            height: 2px; 
            background: var(--pipe-color);
            transition: 0.3s; 
            position: relative; 
        }
        .hub-trigger { 
            width: 20px; 
            height: 20px; 
            border-radius: 50%; 
            background: var(--node-bg);
            border: 2px solid var(--node-border);
            color: var(--text-primary);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            cursor: pointer; 
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%); 
            opacity: 0; 
            transition:0.2s;
        }
        .branch-hub.active .hub-arm { width: 300px; }
        .branch-hub.active .hub-trigger { opacity: 1; }
        .trigger-left { left: 0; transform: translate(-50%, -50%); }
        .trigger-right { right: 0; transform: translate(50%, -50%); }

        /* --- PLOT COLUMNS --- */
        #plot-grid-container {
            display: flex; align-items: flex-start; gap: 60px; justify-content: center;
            width: max-content; 
            min-width: 100%;
        }
        .plot-column { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-width: 550px; 
            width: 550px; 
            transition: width 0.3s ease, transform 0.3s ease; 
            overflow-x: visible; 
        }
        .side-column { opacity: 0.8; transform: scale(0.95); transform-origin: top center; }
        .side-column:hover { opacity: 1; }

        /* --- PLOT & EVENT NODES --- */
        .plot-node-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; margin-bottom: 0px; }
        .plot-node {
            width: 100%; 
            background: var(--panel-bg);
            border: 2px solid var(--border);
            border-radius: 15px; 
            padding: 25px; 
            box-sizing: border-box;
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transition: width 0.3s ease;
        }
        .plot-title-field {
            background: transparent; border: none; border-bottom: 2px solid var(--border); color: var(--text-primary); font-size: 0.9rem; letter-spacing: 3px; text-transform: uppercase;
            padding-bottom: 8px; outline: none; width: 100%; font-family: 'JetBrains Mono'; text-align: center;
        }
        
        .event-node {
            display: flex; 
            flex-direction: row; 
            background: var(--panel-bg);
            border: 2px solid var(--border);
            border-radius: 12px; 
            overflow: hidden; 
            transition: width 0.3s ease;
            position: relative; 
            width: 100%;
        }
        .event-node.flipped { flex-direction: row-reverse; }
        
        .event-text-container { 
            flex: 0 0 420px; /* Larger fixed width - ensures text is always longer than image */
            min-width: 420px;
            max-width: 420px;
            padding: 15px 20px; 
            position: relative; 
            display: flex; 
            flex-direction: column;
        }
        .event-input {
            background: transparent; border: none; color: var(--text-primary); resize: none; width: 100%; font-size: 0.85rem; line-height: 1.6; outline: none;
            font-family: 'Inter', sans-serif; min-height: 40px; display: block; overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .char-count { font-size: 0.5rem; color: #444; text-align: right; margin-top: 5px; font-family: 'JetBrains Mono'; }

        .event-image-container {
            flex-shrink: 0; 
            background: var(--node-bg);
            border-left: 2px solid var(--border);
            cursor: pointer; 
            overflow: hidden; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            position: relative;
            width: 213px;
            height: 160px;
            min-width: 213px;
            max-width: 213px;
            min-height: 160px;
            max-height: 160px;
        }
        .event-node.flipped .event-image-container { border-left: none; border-right: 2px solid var(--border); }
        .event-image-container img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .event-image-container:hover img { transform: scale(1.05); opacity: 0.8; }
        .img-placeholder { padding: 10px; font-size: 0.5rem; color: #444; letter-spacing: 1px; text-align: center; position: absolute; }

        .event-tools {
            position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; opacity: 0; transition: 0.2s;
            background: var(--node-bg);
            border: 1px solid var(--border);
            padding: 2px 4px; border-radius: 4px;
        }
        .event-node:hover .event-tools { opacity: 1; }
        .tool-btn {
            cursor: pointer; font-size: 10px; color: var(--text-dim); width: 16px; height: 16px; 
            display: flex; align-items: center; justify-content: center; border-radius: 3px;
        }
        .tool-btn:hover { 
            color: var(--text-primary);
            background: var(--border);
        }
        .tool-delete:hover { color: var(--danger); background: rgba(255, 68, 68, 0.1); }

        /* Event reorder arrows */
        .event-reorder {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .event-node:hover .event-reorder { opacity: 1; }
        .reorder-arrow {
            width: 0;
            height: 0;
            cursor: pointer;
            transition: 0.2s;
        }
        .reorder-arrow.up {
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 8px solid var(--text-dim);
        }
        .reorder-arrow.up:hover {
            border-bottom-color: var(--text-primary);
        }
        .reorder-arrow.down {
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid var(--text-dim);
        }
        .reorder-arrow.down:hover {
            border-top-color: var(--text-primary);
        }

        /* Event reorder arrows */
        .event-reorder {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 4px;
            opacity: 0;
            transition: 0.2s;
        }
        .event-node:hover .event-reorder { opacity: 1; }
        .reorder-arrow {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            cursor: pointer;
            transition: 0.2s;
        }
        .arrow-up {
            border-bottom: 8px solid var(--text-dim);
        }
        .arrow-up:hover {
            border-bottom-color: var(--text-primary);
        }
        .arrow-down {
            border-top: 8px solid var(--text-dim);
        }
        .arrow-down:hover {
            border-top-color: var(--text-primary);
        }

        /* Drag & Drop Styles */
        .draggable { cursor: grab; }
        .draggable:active { cursor: grabbing; }
        .dragging { opacity: 0.4; border: 1px dashed var(--accent) !important; }
        .drag-over { border: 1px solid var(--accent) !important; background: rgba(255,255,255,0.05); }

        /* --- TIMELINE HUD --- */
        #timeline-hud { position: fixed; left: 50%; top: 80px; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 1500; }
        #timeline-bar { 
            width: 600px; 
            height: 40px; 
            background: var(--hud-bg);
            border: 1px solid var(--hud-border);
            border-radius: 4px; 
            position: relative; 
        }
        .timeline-axis { 
            position: absolute; 
            top: 50%; 
            left: 0; 
            width: 100%; 
            height: 1px; 
            background: var(--pipe-color);
            transform: translateY(-50%); 
        }
        .year-dot, .year-line { cursor: pointer; position: absolute; top: 50%; transform: translate(-50%, -50%); transition: 0.2s; }
        .year-dot { 
            width: 12px; 
            height: 12px; 
            background: var(--text-dim);
            border: 2px solid var(--hud-bg);
            border-radius: 50%; 
            z-index: 20; 
        }
        .year-line { 
            width: 2px; 
            height: 15px; 
            background: var(--text-dim);
            z-index: 10; 
        }
        .selected-marker { background: var(--accent) !important; box-shadow: 0 0 15px var(--accent); height: 20px !important; width: 2px !important; }
        
        .year-box { 
            position: absolute; 
            background: var(--hud-bg);
            border: 1px solid var(--hud-border);
            padding: 4px 8px; 
            font-family: 'JetBrains Mono'; 
            font-size: 0.6rem; 
            color: var(--hud-text);
            pointer-events: none; 
        }
        .box-min { right: 100%; margin-right: 15px; top: 50%; transform: translateY(-50%); }
        .box-max { left: 100%; margin-left: 15px; top: 50%; transform: translateY(-50%); }
        .box-above { bottom: 100%; margin-bottom: 10px; left: 50%; transform: translateX(-50%); opacity: 0; }
        .year-line:hover .box-above, .selected-marker .box-above { opacity: 1; }

        .tm-btn { 
            background: var(--hud-bg);
            border: 1px solid var(--hud-border);
            color: var(--text-dim);
            font-size: 0.55rem; 
            padding: 8px 16px; 
            text-transform: uppercase; 
            cursor: pointer; 
            transition: 0.2s; 
            letter-spacing: 1px; 
        }
        .tm-btn:hover { 
            color: var(--hud-text);
            border-color: var(--text-dim);
        }
        
        .add-circle {
            width: 40px; 
            height: 40px; 
            border: 1px solid var(--pipe-color);
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer;
            color: var(--text-dim);
            font-size: 1.2rem; 
            transition: 0.3s; 
            background: var(--node-bg);
            backdrop-filter: blur(5px); 
            margin-top: 10px;
        }
        .add-circle:hover { 
            border-color: var(--text-primary);
            color: var(--text-primary);
            transform: scale(1.1); 
        }

        /* --- CHARACTER JOURNAL MODAL --- */
        .character-modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            padding: 40px;
            max-width: 90vw;
            max-height: 90vh;
            pointer-events: all;
        }

        .character-journal {
            width: 800px;
            max-height: 70vh;
            background: rgba(12, 12, 12, 0.95);
            border: 1px solid #333;
            border-radius: 15px;
            padding: 30px;
            overflow-y: auto;
        }

        .journal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #222;
            padding-bottom: 15px;
        }

        .journal-header h2 {
            font-size: 1rem;
            font-weight: 300;
            letter-spacing: 3px;
            margin: 0;
            text-transform: uppercase;
        }

        .close-journal {
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            transition: 0.2s;
            line-height: 1;
        }

        .close-journal:hover {
            color: #fff;
        }

        .character-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }

        .character-profile {
            width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .character-profile:hover {
            transform: scale(1.05);
        }

        .character-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #111;
            border: 2px solid #333;
            object-fit: cover;
            transition: 0.2s;
        }

        .character-profile:hover .character-avatar {
            border-color: #666;
        }

        .character-name {
            font-size: 0.7rem;
            color: #ddd;
            text-align: center;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .add-character-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(20, 20, 20, 0.8);
            border: 2px dashed #444;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #444;
            cursor: pointer;
            transition: 0.3s;
        }

        .add-character-btn:hover {
            border-color: #fff;
            color: #fff;
            background: rgba(30, 30, 30, 0.9);
            transform: scale(1.05);
        }

        /* Character detail view */
        .character-detail-view {
            width: 500px;
            background: rgba(12, 12, 12, 0.98);
            border: 1px solid #333;
            border-radius: 15px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }

        .detail-avatar {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: #111;
            border: 4px solid #333;
            background-size: cover;
            background-position: center;
        }

        .detail-name {
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 2px;
            text-align: center;
        }

        .detail-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .detail-btn {
            padding: 14px 24px;
            background: var(--node-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: 0.2s;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
        }

        .detail-btn:hover {
            background: var(--border);
        }

        .detail-btn.added {
            background: rgba(50, 100, 50, 0.3);
            color: #4a4;
            cursor: default;
            border-color: #4a4;
        }

        .detail-btn.remove {
            background: rgba(100, 30, 30, 0.3);
            border-color: var(--danger);
            color: var(--danger);
        }

        .detail-btn.remove:hover {
            background: rgba(100, 30, 30, 0.5);
        }

        .detail-btn.delete {
            background: rgba(100, 30, 30, 0.3);
            border-color: var(--danger);
            color: var(--danger);
        }

        .detail-btn.delete:hover {
            background: rgba(100, 30, 30, 0.5);
        }

        .detail-back {
            font-size: 0.7rem;
            color: #666;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.2s;
        }

        .detail-back:hover {
            color: #fff;
        }

        /* --- CHARACTER PROFILE EDITOR --- */
        .character-editor-panel {
            width: 700px;
            max-height: 90vh;
            background: rgba(12, 12, 12, 0.98);
            border: 1px solid #333;
            border-radius: 15px;
            padding: 25px 30px;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

        .editor-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid #222;
            padding-bottom: 12px;
        }

        .editor-header h2 {
            font-size: 0.8rem;
            font-weight: 300;
            letter-spacing: 3px;
            margin: 0;
            flex-grow: 1;
        }

        .save-indicator {
            font-size: 0.5rem;
            color: #4a4;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .close-editor {
            font-size: 1.8rem;
            color: #666;
            cursor: pointer;
            transition: 0.2s;
            line-height: 1;
        }

        .close-editor:hover {
            color: #fff;
        }

        .editor-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 20px;
        }

        .editor-section {
            display: flex;
            flex-direction: column;
        }

        .editor-section.full-width {
            grid-column: 1 / -1;
        }

        .editor-section label {
            font-size: 0.55rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .editor-section input[type="text"],
        .editor-section textarea,
        .editor-section select {
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            outline: none;
            border-radius: 4px;
            transition: 0.2s;
        }

        .editor-section input:focus,
        .editor-section textarea:focus,
        .editor-section select:focus {
            border-color: #666;
        }

        .editor-section textarea {
            min-height: 80px;
            resize: vertical;
        }

        .editor-section select {
            cursor: pointer;
        }

        .editor-row {
            display: flex;
            gap: 15px;
        }

        .char-preview-container {
            width: 100px;
            height: 100px;
            margin-bottom: 8px;
        }

        .char-preview-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #333;
            display: none;
        }

        .char-preview-circle.visible {
            display: block;
        }

        .char-placeholder-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #111;
            border: 2px dashed #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #444;
            font-size: 0.5rem;
        }

        .color-picker {
            width: 100%;
            height: 45px;
            border: 1px solid #333;
            background: #000;
            cursor: pointer;
            border-radius: 4px;
        }

        .color-preview {
            margin-top: 8px;
            height: 30px;
            border-radius: 4px;
            border: 1px solid #333;
        }

        /* --- CHARACTER JOURNAL MODAL --- */
        .character-modal-content {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            pointer-events: none;
        }

        /* Character Detail Popup - compact, horizontal layout */
        .character-detail-popup {
            position: absolute;
            top: 10vh;
            left: 50%;
            transform: translateX(-50%);
            width: 900px;
            max-height: 30vh;
            background: rgba(12, 12, 12, 0.98);
            border: 1px solid #333;
            border-radius: 15px;
            display: none;
            flex-direction: row;
            align-items: center;
            gap: 30px;
            padding: 30px 40px;
            pointer-events: all;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            opacity: 1;
            transition: opacity 1.5s ease-out;
        }

        .character-detail-popup.active {
            display: flex;
        }

        .character-detail-popup.fading {
            opacity: 0;
        }

        .detail-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }

        .detail-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #111;
            border: 4px solid #333;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .detail-name {
            font-size: 1.2rem;
            font-weight: 400;
            letter-spacing: 2px;
            text-align: left;
            min-width: 150px;
        }

        .detail-buttons {
            display: flex;
            gap: 12px;
            flex: 1;
        }

        .detail-btn {
            flex: 1;
            padding: 14px 16px;
            background: var(--node-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: 0.2s;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }

        .detail-btn:hover:not(.added) {
            background: var(--border);
        }

        .detail-btn.added {
            background: rgba(50, 100, 50, 0.3);
            color: #4a4;
            cursor: default;
            border-color: #4a4;
        }

        .detail-btn.delete {
            background: rgba(100, 30, 30, 0.3);
            border-color: var(--danger);
            color: var(--danger);
        }

        .detail-btn.delete:hover {
            background: rgba(100, 30, 30, 0.5);
        }

        /* Character Journal - compact bottom panel */
        .character-journal {
            width: 900px;
            max-height: 45vh;
            background: rgba(12, 12, 12, 0.95);
            border: 1px solid #333;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-self: center;
            pointer-events: all;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
        }

        .journal-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px 30px;
            border-bottom: 1px solid #222;
            flex-shrink: 0;
        }

        .journal-header h2 {
            font-size: 0.9rem;
            font-weight: 300;
            letter-spacing: 3px;
            margin: 0;
            text-transform: uppercase;
        }

        /* Character List Section */
        .character-list-section {
            flex: 1;
            padding: 25px 30px 20px 30px;
            overflow-y: auto;
        }

        .character-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }

        .character-profile {
            width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .character-profile:hover {
            transform: scale(1.05);
        }

        .character-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #111;
            border: 2px solid #333;
            object-fit: cover;
            transition: 0.2s;
            background-size: cover;
            background-position: center;
        }

        .character-profile:hover .character-avatar {
            border-color: #666;
        }

        .character-name {
            font-size: 0.7rem;
            color: #ddd;
            text-align: center;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .add-character-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(20, 20, 20, 0.8);
            border: 2px dashed #444;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #444;
            cursor: pointer;
            transition: 0.3s;
        }

        .add-character-btn:hover {
            border-color: #fff;
            color: #fff;
            background: rgba(30, 30, 30, 0.9);
            transform: scale(1.05);
        }

        /* Dismiss button at bottom */
        .journal-footer {
            padding: 15px 30px;
            border-top: 1px solid #222;
            display: flex;
            justify-content: center;
        }

        .dismiss-journal-btn {
            padding: 12px 30px;
            background: var(--node-bg);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: 0.2s;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }

        .dismiss-journal-btn:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        /* Scene Characters in Node */
        .scene-characters-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 8px;
        }

        .scene-char-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #111;
            border: 2px solid #333;
            cursor: pointer;
            transition: 0.2s;
            background-size: cover;
            background-position: center;
        }

        .scene-char-avatar:hover {
            transform: scale(1.1);
            border-color: var(--danger);
        }

        /* --- CHARACTER INFO PANEL (View Only) --- */
        .character-info-panel {
            width: 500px;
            max-height: 80vh;
            background: rgba(12, 12, 12, 0.98);
            border: 1px solid #333;
            border-radius: 15px;
            padding: 30px;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #222;
            padding-bottom: 15px;
        }

        .info-header h2 {
            font-size: 1.2rem;
            font-weight: 400;
            letter-spacing: 2px;
            margin: 0;
        }

        .close-info {
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            transition: 0.2s;
            line-height: 1;
        }

        .close-info:hover {
            color: #fff;
        }

        .info-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .info-avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .info-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #111;
            border: 3px solid #333;
            background-size: cover;
            background-position: center;
        }

        .info-color-badge {
            width: 60px;
            height: 30px;
            border-radius: 15px;
            border: 1px solid #333;
        }

        .info-details {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-row label {
            font-size: 0.6rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 0.9rem;
            color: #ddd;
            line-height: 1.6;
        }

        .bio-text {
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            border: 1px solid #222;
        }

        .info-notice {
            margin-top: 20px;
            padding: 15px;
            background: rgba(40, 40, 60, 0.3);
            border: 1px solid #334;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #999;
            text-align: center;
            line-height: 1.5;
        }

        /* --- SETTINGS PANEL --- */
        .settings-panel {
            width: 400px;
            background: rgba(12, 12, 12, 0.98);
            border: 1px solid #333;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #222;
            padding-bottom: 15px;
        }

        .settings-header h2 {
            font-size: 0.9rem;
            font-weight: 300;
            letter-spacing: 3px;
            margin: 0;
        }

        .close-settings {
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            transition: 0.2s;
            line-height: 1;
        }

        .close-settings:hover {
            color: #fff;
        }

        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .setting-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .setting-label {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .toggle-switch {
            position: relative;
            width: 180px;
            height: 40px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            transition: 0.3s;
        }

        .toggle-slider {
            position: absolute;
            left: 4px;
            width: 80px;
            height: 32px;
            background: #fff;
            border-radius: 16px;
            transition: 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            left: calc(100% - 84px);
        }

        .toggle-text-left,
        .toggle-text-right {
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 1;
            transition: 0.3s;
        }

        .toggle-text-left {
            color: #1a1a1a;
        }

        .toggle-text-right {
            color: #666;
        }

        .toggle-switch.active .toggle-text-left {
            color: #666;
        }

        .toggle-switch.active .toggle-text-right {
            color: #1a1a1a;
        }

        /* 4-Way Theme Toggle */
        .theme-toggle-4way {
            position: relative;
            width: 100%;
            height: 80px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 4px;
            gap: 4px;
        }

        .theme-slider {
            position: absolute;
            width: calc(25% - 5px);
            height: calc(100% - 8px);
            background: #fff;
            border-radius: 8px;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            left: 4px;
            top: 4px;
            z-index: 0;
        }

        .theme-option {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1;
            transition: 0.2s;
            border-radius: 8px;
        }

        .theme-option span {
            font-size: 0.65rem;
            font-weight: 600;
            text-align: center;
            line-height: 1.3;
            color: #666;
            transition: 0.2s;
        }

        .theme-option.active span {
            color: #1a1a1a;
        }

        .theme-toggle-4way[data-active="dark"] .theme-slider {
            left: 4px;
        }

        .theme-toggle-4way[data-active="light-on-dark"] .theme-slider {
            left: calc(25% + 1px);
        }

        .theme-toggle-4way[data-active="dark-on-light"] .theme-slider {
            left: calc(50% - 2px);
        }

        .theme-toggle-4way[data-active="light"] .theme-slider {
            left: calc(75% - 5px);
        }
    </style>
</head>
<body>

    <header class="workspace-header">
        <div class="brand-block">
            <div class="back-btn" onclick="exitWorkspace()">‚Üê</div>
            <div class="nav-text">
                <strong>ALPHALINE</strong> <span class="title-sep">|</span> CREATION PLANE 
                <span style="color: #444; margin: 0 10px;">//</span> 
                <span id="project-name-display" style="color: #fff; opacity: 0.8;"></span>
            </div>
        </div>
        <div class="status-block">
            <div id="save-status" class="save-indicator">CHANGES SYNCED</div>
            <div id="workspace-clock" class="clock-block"></div>
        </div>
    </header>

    <div id="year-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">Episode Number</div>
            <input type="number" id="year-input" class="modal-input" placeholder="#">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="tm-btn" onclick="closeYearModal()">Cancel</button>
                <button class="tm-btn" style="color:#fff; border-color:#fff;" onclick="confirmNewYear()">Create</button>
            </div>
        </div>
    </div>

    <div id="lightbox" class="modal-overlay" onclick="closeLightbox(event)">
        <div id="lightbox-img-container" onclick="event.stopPropagation()">
            <img id="lightbox-img" src="" alt="Event Media">
            <div class="lightbox-controls">
                <button class="tm-btn" style="color:var(--danger)" onclick="deleteLightboxImage()">Delete</button>
                <button class="tm-btn" onclick="replaceLightboxImage()">Replace</button>
                <button class="tm-btn" onclick="document.getElementById('lightbox').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <div id="character-overlay" class="modal-overlay" style="display:none;">
        <div class="character-modal-content" onclick="event.stopPropagation()">
            <!-- Character Detail Popup - compact horizontal layout -->
            <div id="character-detail-popup" class="character-detail-popup">
                <div class="detail-left">
                    <div id="detail-avatar" class="detail-avatar"></div>
                    <div id="detail-name" class="detail-name"></div>
                </div>
                <div class="detail-buttons">
                    <button id="add-to-episode-btn" class="detail-btn" onclick="addCharacterFromDetail()">Add Character to Episode</button>
                    <button class="detail-btn" onclick="editCharacterFromDetail()">Edit Character</button>
                    <button class="detail-btn delete" onclick="deleteCharacterFromDetail()">Delete Character</button>
                </div>
            </div>

            <!-- Character Journal - bottom panel -->
            <div id="character-journal" class="character-journal">
                <div class="journal-header">
                    <h2>CHARACTER JOURNAL</h2>
                </div>

                <div class="character-list-section">
                    <div class="character-list" id="character-list">
                        <!-- Character profiles will be rendered here -->
                    </div>
                </div>

                <div class="journal-footer">
                    <button class="dismiss-journal-btn" onclick="closeCharacterJournal()">Dismiss Character Journal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Profile Editor -->
    <div id="character-editor-overlay" class="modal-overlay" style="display:none; z-index:4000;">
        <div class="character-editor-panel" onclick="event.stopPropagation()">
            <div class="editor-header">
                <h2 id="editor-title">NEW CHARACTER</h2>
                <div class="save-indicator">Auto-saved</div>
                <div class="close-editor" onclick="closeCharacterEditor()">√ó</div>
            </div>

            <div class="editor-content">
                <div class="editor-section">
                    <label>Character Name</label>
                    <input type="text" id="char-name" placeholder="Enter name..." oninput="autoSaveCharacter()">
                </div>

                <div class="editor-section">
                    <label>Status</label>
                    <select id="char-status" onchange="autoSaveCharacter()">
                        <option value="Unknown">Unknown</option>
                        <option value="Alive">Alive</option>
                        <option value="Deceased">Deceased</option>
                        <option value="Missing">Missing</option>
                        <option value="Imprisoned">Imprisoned</option>
                    </select>
                </div>

                <div class="editor-section full-width">
                    <label>Aliases (comma-separated)</label>
                    <input type="text" id="char-aliases" placeholder="e.g. The Shadow, Johnny" oninput="autoSaveCharacter()">
                </div>

                <div class="editor-section">
                    <label>Photo Reference</label>
                    <div class="char-preview-container">
                        <div id="char-placeholder" class="char-placeholder-circle">Empty</div>
                        <img src="" id="char-preview-img" class="char-preview-circle">
                    </div>
                    <button class="tm-btn" onclick="document.getElementById('char-img-upload').click()" style="margin-top:8px; font-size:0.65rem; padding:6px 12px;">Upload</button>
                    <input type="text" id="char-img-url" placeholder="Or URL" oninput="autoSaveCharacter()" style="margin-top:6px;">
                </div>

                <div class="editor-section">
                    <label>Color Code</label>
                    <input type="color" id="char-color" value="#888888" oninput="autoSaveCharacter()" class="color-picker">
                    <div class="color-preview" id="color-preview"></div>
                </div>

                <div class="editor-section full-width">
                    <label>Biography</label>
                    <textarea id="char-bio" placeholder="Character background and details..." oninput="autoSaveCharacter()"></textarea>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="char-img-upload" hidden accept="image/*" onchange="handleCharacterImageUpload(this)">

    <!-- Character Info Panel (View Only) -->
    <div id="character-info-overlay" class="modal-overlay" style="display:none; z-index:4500;" onclick="closeCharacterInfo()">
        <div class="character-info-panel" onclick="event.stopPropagation()">
            <div class="info-header">
                <h2 id="info-char-name">Character Name</h2>
                <div class="close-info" onclick="closeCharacterInfo()">√ó</div>
            </div>

            <div class="info-content">
                <div class="info-avatar-section">
                    <div id="info-avatar" class="info-avatar"></div>
                    <div id="info-color-badge" class="info-color-badge"></div>
                </div>

                <div class="info-details">
                    <div class="info-row" id="info-aliases-row" style="display:none;">
                        <label>Aliases</label>
                        <div id="info-aliases" class="info-value"></div>
                    </div>

                    <div class="info-row">
                        <label>Status</label>
                        <div id="info-status" class="info-value"></div>
                    </div>

                    <div class="info-row" id="info-bio-row" style="display:none;">
                        <label>Biography</label>
                        <div id="info-bio" class="info-value bio-text"></div>
                    </div>

                    <div class="info-notice">
                        Select the Characters node to edit Character Profiles.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="trash-zone" title="Drop Plot here to delete">üóë</div>

    <div id="plane-container">
        <div id="node-group">
            <div class="grid-node">
                <div class="node-label">Episode</div>
                <h2 id="grid-year-display">0000</h2>
                <input type="text" id="episode-title" class="episode-title-input" placeholder="Episode Title" oninput="handleEpisodeTitle(this)">
            </div>
            <div class="node-pipe"></div>
            
            <div class="sub-node" onclick="openCharacterJournal()">
                <div class="node-label">Characters</div>
                <div style="font-size: 0.5rem; color: #444;">Click here to add characters/view Character Journal</div>
            </div>
            <div class="node-pipe"></div>

            <div class="synopsis-node">
                <div class="node-label" style="margin-bottom:8px;">Synopsis</div>
                <textarea id="synopsis-text" class="synopsis-input" placeholder="Enter year synopsis..." oninput="handleSynopsis(this)"></textarea>
            </div>

            <div id="branch-hub" class="branch-hub">
                <div class="hub-arm">
                    <div class="hub-trigger trigger-left" onclick="addNewPlotNode(0, 'left')">+</div>
                </div>
                <div class="hub-center-line">
                    <div class="pipe-add" onclick="addNewPlotNode(0, 'main')">+</div>
                </div>
                <div class="hub-arm">
                    <div class="hub-trigger trigger-right" onclick="addNewPlotNode(0, 'right')">+</div>
                </div>
            </div>

            <div id="plot-grid-container">
                <div id="col-left" class="plot-column side-column"></div>
                <div id="col-main" class="plot-column"></div>
                <div id="col-right" class="plot-column side-column"></div>
            </div>
        </div>
        
        <div id="timeline-hud">
            <div id="timeline-bar"></div>
            <div style="display: flex; gap: 10px;">
                <button class="tm-btn" onclick="openSettingsModal()" style="font-size: 1rem; padding: 4px 10px;">üî¶</button>
                <button class="tm-btn" onclick="toggleDistribution()">Toggle Distribution</button>
                <button class="tm-btn" onclick="openYearModal()">New Episode</button>
                <button id="center-btn" class="tm-btn" style="display:none;" onclick="resetGraphView()">Reset Graph View</button>
                <button id="delete-btn" class="tm-btn" style="color:var(--danger); display:none;" onclick="handleDeleteYear()">Delete Episode</button>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settings-overlay" class="modal-overlay" style="display:none; z-index:3500;">
        <div class="settings-panel" onclick="event.stopPropagation()">
            <div class="settings-header">
                <h2>SETTINGS</h2>
                <div class="close-settings" onclick="closeSettingsModal()">√ó</div>
            </div>
            
            <div class="settings-content">
                <div class="setting-row">
                    <label class="setting-label">Theme Mode</label>
                    <div class="theme-toggle-4way">
                        <div id="theme-slider-4way" class="theme-slider"></div>
                        <div class="theme-option" data-theme="dark" onclick="setThemeMode('dark')">
                            <span>Dark</span>
                        </div>
                        <div class="theme-option" data-theme="light-on-dark" onclick="setThemeMode('light-on-dark')">
                            <span>Light<br>on Dark</span>
                        </div>
                        <div class="theme-option" data-theme="dark-on-light" onclick="setThemeMode('dark-on-light')">
                            <span>Dark<br>on Light</span>
                        </div>
                        <div class="theme-option" data-theme="light" onclick="setThemeMode('light')">
                            <span>Light</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let plotsByYear = {}; 
        let selectedYear = null;
        let isDistributed = false;
        let panX = 0, panY = 0, gridZoom = 1;

        // Characters data
        let characters = [];
        let editingCharacterId = null;

        // Lightbox State
        let lbContext = { pIdx: null, eIdx: null, col: null };

        // Drag State
        let dragSrcEl = null;
        let dragType = null; 

        // Set Project Name from Universe
        const urlParams = new URLSearchParams(window.location.search);
        const universeId = urlParams.get('id');
        let currentUniverse = null;
        let projName = "UNTITLED PROJECT";
        let seriesName = "";

        if (universeId) {
            const universes = JSON.parse(localStorage.getItem('alphaline_universes') || '[]');
            currentUniverse = universes.find(u => u.id === parseInt(universeId));
            
            if (currentUniverse) {
                projName = currentUniverse.name || "UNTITLED PROJECT";
                seriesName = currentUniverse.series || "";
            }
        }

        // Display project name and series
        const displayHTML = seriesName 
            ? `<span style="font-size: 0.5rem; color: #666; display: block; margin-bottom: 2px;">${seriesName}</span>${projName}`
            : projName;
        document.getElementById('project-name-display').innerHTML = displayHTML;

        // Initialize currentUniverse with years array
        if (!currentUniverse) {
            currentUniverse = { years: [] };
        } else if (!currentUniverse.years) {
            currentUniverse.years = [];
        }

        function updateClock() {
            const now = new Date();
            
            // Get 12-hour time with AM/PM
            let hours = now.getHours();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const time12hr = `${hours}:${minutes}:${seconds} ${ampm}`;
            
            // Get timezone info
            const timezoneName = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const timezoneAbbr = new Date().toLocaleTimeString('en-US', { timeZoneName: 'short' }).split(' ').pop();
            
            // Calculate offset from PST (UTC-8 standard, UTC-7 daylight)
            const localOffset = -now.getTimezoneOffset() / 60; // Convert minutes to hours
            const pstOffset = -8; // PST is UTC-8 (standard time)
            const pdtOffset = -7; // PDT is UTC-7 (daylight time)
            
            // Determine if PST is currently observing daylight time
            const jan = new Date(now.getFullYear(), 0, 1);
            const jul = new Date(now.getFullYear(), 6, 1);
            const stdOffset = Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
            const isDST = now.getTimezoneOffset() < stdOffset;
            
            const currentPstOffset = isDST ? pdtOffset : pstOffset;
            const offsetFromPst = localOffset - currentPstOffset;
            const pstLabel = isDST ? 'PDT' : 'PST';
            
            let offsetText = '';
            if (offsetFromPst === 0) {
                offsetText = `(${pstLabel})`;
            } else if (offsetFromPst > 0) {
                offsetText = `(${pstLabel} +${offsetFromPst}hr)`;
            } else {
                offsetText = `(${pstLabel} ${offsetFromPst}hr)`;
            }
            
            const date = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }).toUpperCase();
            
            document.getElementById('workspace-clock').innerHTML = `${time12hr} ${timezoneAbbr} ${offsetText}<br>${date}`;
        }
        setInterval(updateClock, 1000); updateClock();

        function exitWorkspace() {
            // Set localStorage flag for universes page to restore panels
            localStorage.setItem('alphaline_restore_panels', 'true');
            
            // Send postMessage as backup
            window.parent.postMessage('RESTORE_PANELS', '*');
            
            // Navigate back to universes page
            window.location.href = 'universes.html';
        }

        // Camera Controls
        const plane = document.getElementById('plane-container');
        const nodeGroup = document.getElementById('node-group');

        plane.onmousedown = (e) => {
            if (e.target.closest('.plot-node') || e.target.closest('.modal-overlay') || e.target.closest('.event-node') || e.target.closest('.synopsis-node') || e.target.closest('#timeline-hud') || e.target.closest('.workspace-header')) return;
            let sx = e.clientX - panX, sy = e.clientY - panY;
            plane.onmousemove = (me) => {
                panX = me.clientX - sx; panY = me.clientY - sy;
                updateGrid();
            };
        };
        window.onmouseup = () => plane.onmousemove = null;
        
        plane.onwheel = (e) => {
            if (e.target.closest('#timeline-hud')) return;
            const delta = e.deltaY < 0 ? 1.1 : 0.9;
            gridZoom = Math.min(Math.max(0.1, gridZoom * delta), 3);
            updateGrid();
        };

        function updateGrid() {
            const b = 20 * gridZoom;
            plane.style.backgroundSize = `${b}px ${b}px`;
            plane.style.backgroundPosition = `${panX}px ${panY}px`;
            nodeGroup.style.transform = `translate(calc(-50% + ${panX}px), calc(-50% + ${panY}px)) scale(${gridZoom})`;
        }

        // Center and zoom the node graph
        function resetGraphView() {
            // Focus on Episode/Characters/Synopsis nodes at top
            // Leave room at bottom for timeline (approximately 200px)
            panX = 0;
            panY = -200; // Offset upward to keep top nodes visible with timeline
            gridZoom = 0.7; // Zoom level to see all three top nodes
            updateGrid();
        }

        // Logic
        function ensureYearData(y) {
            if (!plotsByYear[y]) plotsByYear[y] = { episodeTitle: "", synopsis: "", main: [], left: [], right: [] };
        }

        function handleSynopsis(el) {
            autoSize(el);
            if(selectedYear) {
                plotsByYear[selectedYear].synopsis = el.value;
                saveData();
            }
        }

        function handleEpisodeTitle(el) {
            if(selectedYear) {
                plotsByYear[selectedYear].episodeTitle = el.value;
                saveData();
            }
        }

        function addNewPlotNode(index, column) {
            if (!selectedYear) return;
            ensureYearData(selectedYear);
            plotsByYear[selectedYear][column].splice(index, 0, { title: 'NEW PLOT', events: [] });
            renderPlotStack();
            saveData();
        }

        function appendPlotNode(column) {
            if (!selectedYear) return;
            ensureYearData(selectedYear);
            plotsByYear[selectedYear][column].push({ title: 'NEW PLOT', events: [] });
            renderPlotStack();
            saveData();
        }

        function addEventToNode(pIdx, column) {
            plotsByYear[selectedYear][column][pIdx].events.push({ text: '', img: null, flipped: false });
            renderPlotStack();
            saveData();
        }

        function renderPlotStack() {
            const data = plotsByYear[selectedYear];
            if(!data) return;

            // Episode Title
            const episodeTitleInput = document.getElementById('episode-title');
            episodeTitleInput.value = data.episodeTitle || "";

            // Synopsis
            const synBox = document.getElementById('synopsis-text');
            synBox.value = data.synopsis || "";
            autoSize(synBox);

            // Hub Trigger
            const hub = document.getElementById('branch-hub');
            if(data.main.length > 0) hub.classList.add('active');
            else hub.classList.remove('active');

            renderColumn('col-left', data.left, 'left');
            renderColumn('col-main', data.main, 'main');
            renderColumn('col-right', data.right, 'right');
            
            // Render scene characters
            renderSceneCharacters();
            
            // Recalculate widths after rendering
            setTimeout(() => updateColumnWidths(), 50);
        }

        function renderColumn(containerId, plots, colName) {
            const stack = document.getElementById(containerId);
            stack.innerHTML = '';

            plots.forEach((plot, pIdx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'plot-node-wrapper draggable';
                wrapper.setAttribute('draggable', 'true');
                wrapper.dataset.index = pIdx;
                wrapper.dataset.col = colName;
                
                const node = document.createElement('div');
                node.className = 'plot-node';
                node.innerHTML = `
                    <input class="plot-title-field" value="${plot.title}" oninput="updatePlotTitle(${pIdx}, '${colName}', this.value)">
                    <div id="ev-container-${colName}-${pIdx}" style="display:flex; flex-direction:column; gap:12px;"></div>
                    <button class="tm-btn" style="border-radius:8px; border:1px dashed #333;" onclick="addEventToNode(${pIdx}, '${colName}')">+ Add Event</button>
                `;

                // Events
                const evCont = node.querySelector(`#ev-container-${colName}-${pIdx}`);
                plot.events.forEach((ev, eIdx) => {
                    const evNode = document.createElement('div');
                    evNode.className = `event-node draggable ${ev.flipped ? 'flipped' : ''}`;
                    evNode.setAttribute('draggable', 'true');
                    evNode.dataset.pIdx = pIdx;
                    evNode.dataset.eIdx = eIdx;
                    evNode.dataset.col = colName;
                    
                    evNode.innerHTML = `
                        <div class="event-reorder">
                            <div class="reorder-arrow up" onclick="reorderEventUp(${pIdx}, ${eIdx}, '${colName}'); event.stopPropagation();"></div>
                            <div class="reorder-arrow down" onclick="reorderEventDown(${pIdx}, ${eIdx}, '${colName}'); event.stopPropagation();"></div>
                        </div>
                        <div class="event-text-container">
                            <div class="event-tools">
                                <div class="tool-btn" title="Flip Side" onclick="toggleEventSide(${pIdx}, ${eIdx}, '${colName}')">‚Üî</div>
                                <div class="tool-btn tool-delete" title="Delete Event" onclick="deleteEvent(${pIdx}, ${eIdx}, '${colName}')">√ó</div>
                            </div>
                            <textarea class="event-input" maxlength="500" placeholder="Event description..." oninput="handleEventText(this, ${pIdx}, ${eIdx}, '${colName}')">${ev.text}</textarea>
                            <div class="char-count">${ev.text.length}/500</div>
                        </div>
                        <div class="event-image-container" onclick="openLightbox(${pIdx}, ${eIdx}, '${colName}')">
                            ${ev.img ? `<img src="${ev.img}">` : '<span class="img-placeholder">ADD MEDIA</span>'}
                        </div>
                    `;
                    setupDnD(evNode, 'event');
                    evCont.appendChild(evNode);
                    
                    // Auto-size textarea after DOM insertion
                    setTimeout(() => {
                        const textarea = evNode.querySelector('textarea');
                        autoSize(textarea);
                    }, 0);
                });

                setupDnD(wrapper, 'plot');
                wrapper.appendChild(node);

                // Connector Pipe + Add Button
                const pipe = document.createElement('div');
                pipe.className = 'node-pipe';
                pipe.innerHTML = `<div class="pipe-add" onclick="addNewPlotNode(${pIdx + 1}, '${colName}')">+</div>`;
                wrapper.appendChild(pipe);
                
                stack.appendChild(wrapper);
            });

            // Always show trailing (+) for creating new node - even if column is empty
            const trailingAdd = document.createElement('div');
            trailingAdd.className = 'add-circle';
            trailingAdd.style.marginTop = plots.length > 0 ? '20px' : '0px';
            trailingAdd.onclick = () => appendPlotNode(colName);
            trailingAdd.innerText = '+';
            stack.appendChild(trailingAdd);
        }

        function updatePlotTitle(pIdx, col, value) {
            plotsByYear[selectedYear][col][pIdx].title = value;
            saveData();
        }

        // --- ACTIONS ---
        function toggleEventSide(pIdx, eIdx, col) {
            const ev = plotsByYear[selectedYear][col][pIdx].events[eIdx];
            ev.flipped = !ev.flipped;
            renderPlotStack();
            saveData();
        }

        function deleteEvent(pIdx, eIdx, col) {
            if(confirm("Delete this event?")) {
                plotsByYear[selectedYear][col][pIdx].events.splice(eIdx, 1);
                renderPlotStack();
                saveData();
            }
        }

        function reorderEventUp(pIdx, eIdx, col) {
            const events = plotsByYear[selectedYear][col][pIdx].events;
            const event = events[eIdx];
            
            // Remove from current position
            events.splice(eIdx, 1);
            
            // If at top, move to bottom
            if (eIdx === 0) {
                events.push(event);
            } else {
                // Move up one position
                events.splice(eIdx - 1, 0, event);
            }
            
            renderPlotStack();
            saveData();
        }

        function reorderEventDown(pIdx, eIdx, col) {
            const events = plotsByYear[selectedYear][col][pIdx].events;
            const event = events[eIdx];
            
            // Remove from current position
            events.splice(eIdx, 1);
            
            // If at bottom, move to top
            if (eIdx === events.length) {
                events.unshift(event);
            } else {
                // Move down one position
                events.splice(eIdx + 1, 0, event);
            }
            
            renderPlotStack();
            saveData();
        }

        // --- LIGHTBOX ---
        function openLightbox(pIdx, eIdx, col) {
            const ev = plotsByYear[selectedYear][col][pIdx].events[eIdx];
            if(!ev.img) {
                // Trigger upload if no image
                triggerImgUpload(pIdx, eIdx, col);
                return;
            }
            lbContext = { pIdx, eIdx, col };
            document.getElementById('lightbox-img').src = ev.img;
            document.getElementById('lightbox').style.display = 'flex';
        }

        function closeLightbox(e) {
            if(e.target.id === 'lightbox') document.getElementById('lightbox').style.display = 'none';
        }

        function deleteLightboxImage() {
            if(confirm("Remove image?")) {
                plotsByYear[selectedYear][lbContext.col][lbContext.pIdx].events[lbContext.eIdx].img = null;
                document.getElementById('lightbox').style.display = 'none';
                renderPlotStack();
                saveData();
            }
        }

        function replaceLightboxImage() {
            triggerImgUpload(lbContext.pIdx, lbContext.eIdx, lbContext.col);
            document.getElementById('lightbox').style.display = 'none';
        }

        function triggerImgUpload(pIdx, eIdx, col) {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = r => {
                    plotsByYear[selectedYear][col][pIdx].events[eIdx].img = r.target.result;
                    renderPlotStack();
                    saveData();
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            input.click();
        }

        // --- DRAG & DROP ---
        // Setup trash zone listeners ONCE on page load
        function initTrashZone() {
            const trash = document.getElementById('trash-zone');
            
            trash.addEventListener('dragenter', (e) => {
                if(dragType === 'plot') {
                    trash.classList.add('drag-over');
                }
            });
            
            trash.addEventListener('dragleave', () => {
                trash.classList.remove('drag-over');
            });
            
            trash.addEventListener('dragover', (e) => {
                if(dragType === 'plot') {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                }
            });
            
            trash.addEventListener('drop', (e) => {
                e.stopPropagation();
                e.preventDefault();
                
                if(dragType === 'plot' && dragSrcEl) {
                    const idx = parseInt(dragSrcEl.dataset.index);
                    const col = dragSrcEl.dataset.col;
                    
                    if(confirm("Delete this Plot Block?")) {
                        plotsByYear[selectedYear][col].splice(idx, 1);
                        renderPlotStack();
                        saveData();
                    }
                }
                
                trash.classList.remove('drag-over');
            });
        }

        function setupDnD(el, type) {
            el.addEventListener('dragstart', (e) => {
                if(e.target.closest('.tool-btn')) return; 
                dragSrcEl = el;
                dragType = type;
                document.body.classList.add('global-dragging');
                el.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            el.addEventListener('dragover', (e) => {
                e.preventDefault();
                return false;
            });
            
            el.addEventListener('dragenter', () => el.classList.add('drag-over'));
            el.addEventListener('dragleave', () => el.classList.remove('drag-over'));

            el.addEventListener('drop', (e) => {
                e.stopPropagation();
                if (dragSrcEl !== el && dragType === type) {
                    if (type === 'plot') {
                        movePlot(dragSrcEl.dataset.col, parseInt(dragSrcEl.dataset.index), el.dataset.col, parseInt(el.dataset.index));
                    } else if (dragSrcEl.dataset.col === el.dataset.col && dragSrcEl.dataset.pIdx === el.dataset.pIdx) {
                         reorderEvents(el.dataset.col, parseInt(dragSrcEl.dataset.pIdx), parseInt(dragSrcEl.dataset.eIdx), parseInt(el.dataset.pIdx), parseInt(el.dataset.eIdx));
                    }
                }
                return false;
            });
            
            el.addEventListener('dragend', () => {
                document.body.classList.remove('global-dragging');
                document.querySelectorAll('.draggable, #trash-zone').forEach(d => d.classList.remove('dragging', 'drag-over'));
                dragSrcEl = null;
                dragType = null;
            });
        }

        function movePlot(fromCol, fromIdx, toCol, toIdx) {
            const [moved] = plotsByYear[selectedYear][fromCol].splice(fromIdx, 1);
            plotsByYear[selectedYear][toCol].splice(toIdx, 0, moved);
            renderPlotStack();
            saveData();
        }

        function reorderEvents(col, fP, fE, tP, tE) {
            const list = plotsByYear[selectedYear][col][fP].events;
            const [moved] = list.splice(fE, 1);
            list.splice(tE, 0, moved);
            renderPlotStack();
            saveData();
        }

        // --- HELPERS ---
        function handleEventText(el, pIdx, eIdx, col) {
            autoSize(el);
            plotsByYear[selectedYear][col][pIdx].events[eIdx].text = el.value;
            el.nextElementSibling.innerText = `${el.value.length}/500`;
            
            // Update column widths (event widths are now fixed)
            updateColumnWidths();
            
            saveData();
        }

        function updateColumnWidths() {
            // All events are now fixed width: 420px text + 40px padding + 213px image = 673px
            const eventWidth = 673;
            
            ['left', 'main', 'right'].forEach(colName => {
                const column = document.getElementById(`col-${colName}`);
                if (!column) return;
                
                // Check if column has any events
                const hasEvents = column.querySelectorAll('.event-node').length > 0;
                const columnWidth = hasEvents ? eventWidth : 550;
                
                column.style.width = `${columnWidth}px`;
                
                // Offset side columns to prevent overlap
                if (colName === 'left') {
                    const offset = columnWidth - 550;
                    column.style.transform = `translateX(-${offset}px) scale(0.95)`;
                    column.style.transformOrigin = 'top right';
                } else if (colName === 'right') {
                    const offset = columnWidth - 550;
                    column.style.transform = `translateX(${offset}px) scale(0.95)`;
                    column.style.transformOrigin = 'top left';
                } else {
                    column.style.transform = 'scale(1)';
                }
            });
        }

        function autoSize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        // --- TIMELINE NAV ---
        function openYearModal() { 
            document.getElementById('year-modal').style.display = 'flex';
            document.getElementById('year-input').focus();
        }
        
        function closeYearModal() { 
            document.getElementById('year-modal').style.display = 'none';
            document.getElementById('year-input').value = '';
        }
        
        function confirmNewYear() {
            const y = parseInt(document.getElementById('year-input').value);
            if (!isNaN(y) && !currentUniverse.years.includes(y)) {
                const isFirstYear = currentUniverse.years.length === 0;
                
                currentUniverse.years.push(y);
                currentUniverse.years.sort((a,b)=>a-b);
                ensureYearData(y);
                selectYear(y);
                
                // Auto-center on first year creation
                if(isFirstYear) {
                    setTimeout(() => centerAndZoomNodes(), 100);
                }
            }
            closeYearModal();
        }

        function selectYear(y) {
            selectedYear = y;
            ensureYearData(y);
            document.getElementById('grid-year-display').innerText = y;
            document.getElementById('node-group').style.display = 'flex';
            renderTimeline();
            renderPlotStack();
            saveData();
        }

        function renderTimeline() {
            const bar = document.getElementById('timeline-bar');
            bar.innerHTML = '<div class="timeline-axis"></div>';
            
            const centerBtn = document.getElementById('center-btn');
            
            if (currentUniverse.years.length === 0) {
                document.getElementById('delete-btn').style.display = 'none';
                centerBtn.style.display = 'none';
                return;
            }
            
            // Show center button when years exist
            centerBtn.style.display = 'inline-block';
            
            const min = Math.min(...currentUniverse.years);
            const max = Math.max(...currentUniverse.years);
            const range = max - min || 1;
            
            // Min/Max labels
            bar.innerHTML += `<div class="year-box box-min">${min}</div>`;
            bar.innerHTML += `<div class="year-box box-max">${max}</div>`;
            
            currentUniverse.years.forEach((year, index) => {
                let pos;
                
                if (isDistributed) {
                    // Evenly distribute years across timeline
                    const numYears = currentUniverse.years.length;
                    if (numYears === 1) {
                        pos = 50; // Center single year
                    } else {
                        // Space evenly from 0 to 100
                        pos = (index / (numYears - 1)) * 100;
                    }
                } else {
                    // Chronological distribution based on actual year values
                    pos = ((year - min) / range) * 100;
                }
                
                const isSelected = year === selectedYear;
                
                const marker = document.createElement('div');
                marker.className = `year-line ${isSelected ? 'selected-marker' : ''}`;
                marker.style.left = `${pos}%`;
                marker.onclick = () => selectYear(year);
                marker.innerHTML = `<div class="year-box box-above">${year}</div>`;
                
                bar.appendChild(marker);
            });
            
            // Show/hide delete button
            document.getElementById('delete-btn').style.display = 
                selectedYear ? 'inline-block' : 'none';
        }
        
        function toggleDistribution() {
            isDistributed = !isDistributed;
            renderTimeline();
        }
        
        function openSettingsModal() {
            document.getElementById('settings-overlay').style.display = 'flex';
            // Update toggle to reflect current theme
            updateThemeToggleUI();
        }

        function closeSettingsModal() {
            document.getElementById('settings-overlay').style.display = 'none';
        }

        function setThemeMode(mode) {
            // Remove all theme classes
            document.body.classList.remove('theme-dark', 'theme-light', 'theme-dark-on-light', 'theme-light-on-dark');
            
            // Add selected theme class
            if (mode !== 'dark') {
                document.body.classList.add(`theme-${mode}`);
            }
            
            // Save preference
            localStorage.setItem('alphaline_theme', mode);
            
            // Update UI
            updateThemeToggleUI();
        }

        function updateThemeToggleUI() {
            const currentTheme = getCurrentTheme();
            const toggle = document.querySelector('.theme-toggle-4way');
            const options = document.querySelectorAll('.theme-option');
            
            if (toggle) {
                toggle.setAttribute('data-active', currentTheme);
            }
            
            options.forEach(option => {
                if (option.dataset.theme === currentTheme) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        }

        function getCurrentTheme() {
            if (document.body.classList.contains('theme-light')) return 'light';
            if (document.body.classList.contains('theme-dark-on-light')) return 'dark-on-light';
            if (document.body.classList.contains('theme-light-on-dark')) return 'light-on-dark';
            return 'dark';
        }

        // Load theme preference on page load
        function loadThemePreference() {
            const savedTheme = localStorage.getItem('alphaline_theme') || 'dark';
            setThemeMode(savedTheme);
        }

        // --- CHARACTER JOURNAL ---
        function openCharacterJournal() {
            document.getElementById('character-overlay').style.display = 'flex';
            renderCharacterList();
        }

        function closeCharacterJournal() {
            document.getElementById('character-overlay').style.display = 'none';
            closeCharacterDetail(); // Also close detail section
        }

        function renderCharacterList() {
            const list = document.getElementById('character-list');
            list.innerHTML = '';

            // Render existing characters
            characters.forEach((char, index) => {
                const profile = document.createElement('div');
                profile.className = 'character-profile';
                profile.dataset.charId = char.id;
                
                const avatarStyle = char.image ? `background-image: url('${char.image}');` : '';
                const avatarBorder = char.color ? `border-color: ${char.color};` : '';
                
                profile.innerHTML = `
                    <div class="character-avatar" style="${avatarStyle} ${avatarBorder}"></div>
                    <div class="character-name">${char.name}</div>
                `;

                // Click to show detail view
                profile.addEventListener('click', () => {
                    showCharacterDetail(char.id);
                });

                list.appendChild(profile);
            });

            // Add "+" button
            const addBtn = document.createElement('div');
            addBtn.className = 'add-character-btn';
            addBtn.innerHTML = '+';
            addBtn.onclick = () => createNewCharacter();
            list.appendChild(addBtn);
        }

        function createNewCharacter() {
            const newChar = {
                id: Date.now(),
                name: "Unnamed Character",
                aliases: [],
                status: "Unknown",
                bio: "",
                image: null,
                color: "#888888"
            };

            characters.push(newChar);
            saveData();
            openCharacterEditor(newChar.id);
        }

        // --- CHARACTER EDITOR ---
        function openCharacterEditor(charId) {
            editingCharacterId = charId;
            const char = characters.find(c => c.id === charId);
            if (!char) return;

            document.getElementById('editor-title').innerText = char.name === "Unnamed Character" ? "NEW CHARACTER" : "EDIT CHARACTER";
            document.getElementById('char-name').value = char.name;
            document.getElementById('char-aliases').value = char.aliases.join(', ');
            document.getElementById('char-status').value = char.status;
            document.getElementById('char-bio').value = char.bio || "";
            
            // Set image URL
            const imgUrlInput = document.getElementById('char-img-url');
            imgUrlInput.value = char.image || "";
            
            // Set color picker
            const colorPicker = document.getElementById('char-color');
            colorPicker.value = char.color || "#888888";
            
            updateCharacterPreview(char.image);
            updateColorPreview(char.color || "#888888");

            document.getElementById('character-editor-overlay').style.display = 'flex';
        }

        function closeCharacterEditor() {
            if (editingCharacterId) {
                // Check if character is still default/unmodified
                const char = characters.find(c => c.id === editingCharacterId);
                if (char) {
                    const isUnmodified = 
                        char.name === "Unnamed Character" &&
                        char.aliases.length === 0 &&
                        char.status === "Unknown" &&
                        (!char.bio || char.bio.trim() === "") &&
                        (!char.image || char.image === null) &&
                        char.color === "#888888";
                    
                    if (isUnmodified) {
                        // Auto-delete unmodified character
                        characters = characters.filter(c => c.id !== editingCharacterId);
                        saveData();
                        renderCharacterList();
                    }
                }
            }
            
            document.getElementById('character-editor-overlay').style.display = 'none';
            
            // If we were viewing a character detail, go back to it
            if (selectedCharacterId) {
                showCharacterDetail(selectedCharacterId);
            } else {
                editingCharacterId = null;
                renderCharacterList();
            }
        }

        function autoSaveCharacter() {
            if (!editingCharacterId) return;

            const char = characters.find(c => c.id === editingCharacterId);
            if (!char) return;

            char.name = document.getElementById('char-name').value || "Unnamed Character";
            char.aliases = document.getElementById('char-aliases').value.split(',').map(a => a.trim()).filter(a => a);
            char.status = document.getElementById('char-status').value;
            char.bio = document.getElementById('char-bio').value;
            
            // Get image URL from input
            const imgUrlInput = document.getElementById('char-img-url');
            char.image = imgUrlInput.value || null;
            
            // Get color from picker
            const colorPicker = document.getElementById('char-color');
            char.color = colorPicker.value || "#888888";

            updateCharacterPreview(char.image);
            updateColorPreview(char.color);

            saveData();
        }

        function updateCharacterPreview(imgUrl) {
            const img = document.getElementById('char-preview-img');
            const placeholder = document.getElementById('char-placeholder');
            if (imgUrl && imgUrl.trim() !== "") {
                img.src = imgUrl;
                img.classList.add('visible');
                placeholder.style.display = 'none';
            } else {
                img.classList.remove('visible');
                placeholder.style.display = 'flex';
            }
        }

        function updateColorPreview(color) {
            document.getElementById('color-preview').style.backgroundColor = color;
        }

        function handleCharacterImageUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onloadend = () => {
                document.getElementById('char-img-url').value = reader.result;
                autoSaveCharacter();
            };
            reader.readAsDataURL(file);
        }

        // --- CHARACTER DETAIL VIEW ---
        let selectedCharacterId = null;

        function showCharacterDetail(charId) {
            selectedCharacterId = charId;
            const char = characters.find(c => c.id === charId);
            if (!char) return;

            const detailPopup = document.getElementById('character-detail-popup');
            
            // Show detail popup and remove any fading state
            detailPopup.classList.remove('fading');
            detailPopup.classList.add('active');

            // Set avatar
            const avatar = document.getElementById('detail-avatar');
            if (char.image) {
                avatar.style.backgroundImage = `url('${char.image}')`;
            } else {
                avatar.style.backgroundImage = 'none';
            }
            avatar.style.borderColor = char.color || '#333';

            // Set name
            document.getElementById('detail-name').innerText = char.name;

            // Update button state
            updateAddToEpisodeButton();
        }

        function closeCharacterDetail() {
            const detailPopup = document.getElementById('character-detail-popup');
            detailPopup.classList.remove('active', 'fading');
            selectedCharacterId = null;
        }

        function updateAddToEpisodeButton() {
            const btn = document.getElementById('add-to-episode-btn');
            if (!selectedYear || !plotsByYear[selectedYear]) {
                btn.disabled = true;
                btn.innerText = 'No Episode Selected';
                btn.classList.remove('added', 'remove');
                return;
            }

            const scene = plotsByYear[selectedYear];
            const isAdded = scene.sceneCharacters && scene.sceneCharacters.includes(selectedCharacterId);

            if (isAdded) {
                btn.innerText = 'Remove Character from Episode';
                btn.classList.remove('added');
                btn.classList.add('remove');
                btn.disabled = false;
            } else {
                btn.innerText = 'Add Character to Episode';
                btn.classList.remove('added', 'remove');
                btn.disabled = false;
            }
        }

        function addCharacterFromDetail() {
            if (!selectedCharacterId || !selectedYear) return;
            
            const scene = plotsByYear[selectedYear];
            const isAdded = scene.sceneCharacters && scene.sceneCharacters.includes(selectedCharacterId);
            
            if (isAdded) {
                // Remove character
                removeCharacterFromScene(selectedCharacterId);
            } else {
                // Add character
                addCharacterToScene(selectedCharacterId);
                
                // Fade out over 1.5 seconds, then close
                const detailPopup = document.getElementById('character-detail-popup');
                detailPopup.classList.add('fading');
                
                setTimeout(() => {
                    closeCharacterDetail();
                }, 1500);
                return;
            }
            
            updateAddToEpisodeButton();
        }

        function removeCharacterFromScene(charId) {
            if (!selectedYear || !plotsByYear[selectedYear]) return;
            
            const scene = plotsByYear[selectedYear];
            if (!scene.sceneCharacters) return;
            
            scene.sceneCharacters = scene.sceneCharacters.filter(id => id !== charId);
            
            saveData();
            renderTimeline();
        }

        function editCharacterFromDetail() {
            if (!selectedCharacterId) return;
            openCharacterEditor(selectedCharacterId);
        }

        function deleteCharacterFromDetail() {
            if (!selectedCharacterId) return;
            
            const char = characters.find(c => c.id === selectedCharacterId);
            if (!char) return;

            if (confirm(`Permanently delete ${char.name}?`)) {
                deleteCharacter(selectedCharacterId);
                closeCharacterDetail();
            }
        }

        // --- SCENE CHARACTER MANAGEMENT ---
        function addCharacterToScene(charId) {
            if (!selectedYear) return;
            
            ensureYearData(selectedYear);
            if (!plotsByYear[selectedYear].sceneCharacters) {
                plotsByYear[selectedYear].sceneCharacters = [];
            }

            if (!plotsByYear[selectedYear].sceneCharacters.includes(charId)) {
                plotsByYear[selectedYear].sceneCharacters.push(charId);
                saveData();
                renderSceneCharacters();
            }
        }

        function removeCharacterFromScene(charId) {
            if (!selectedYear) return;
            
            const scene = plotsByYear[selectedYear];
            if (scene && scene.sceneCharacters) {
                scene.sceneCharacters = scene.sceneCharacters.filter(id => id !== charId);
                saveData();
                renderSceneCharacters();
            }
        }

        function deleteCharacter(charId) {
            characters = characters.filter(c => c.id !== charId);
            
            // Remove from all scenes
            Object.keys(plotsByYear).forEach(year => {
                if (plotsByYear[year].sceneCharacters) {
                    plotsByYear[year].sceneCharacters = plotsByYear[year].sceneCharacters.filter(id => id !== charId);
                }
            });

            saveData();
            renderCharacterList();
            renderSceneCharacters();
        }

        function renderSceneCharacters() {
            // This will update the Characters node to show linked characters
            const charNode = document.querySelector('.sub-node');
            if (!charNode) return;

            const scene = plotsByYear[selectedYear];
            if (!scene || !scene.sceneCharacters || scene.sceneCharacters.length === 0) {
                charNode.innerHTML = `
                    <div class="node-label">Characters</div>
                    <div style="font-size: 0.5rem; color: #444;">Click here to add characters/view Character Journal</div>
                `;
                return;
            }

            // Show character avatars in the node
            const charAvatars = scene.sceneCharacters.map(id => {
                const char = characters.find(c => c.id === id);
                if (!char) return '';
                
                const imgStyle = char.image ? `background-image: url('${char.image}'); background-size: cover;` : '';
                const borderColor = char.color || '#333';
                
                return `<div class="scene-char-avatar" style="${imgStyle} border-color: ${borderColor};" title="${char.name}" onclick="openCharacterInfo(${id}); event.stopPropagation();"></div>`;
            }).join('');

            charNode.innerHTML = `
                <div class="node-label">Characters</div>
                <div class="scene-characters-row">${charAvatars}</div>
            `;
        }

        // --- CHARACTER INFO PANEL (View Only) ---
        let viewingCharacterId = null;

        function openCharacterInfo(charId) {
            viewingCharacterId = charId;
            const char = characters.find(c => c.id === charId);
            if (!char) return;

            document.getElementById('info-char-name').innerText = char.name;
            
            // Avatar
            const avatar = document.getElementById('info-avatar');
            if (char.image) {
                avatar.style.backgroundImage = `url('${char.image}')`;
            } else {
                avatar.style.backgroundImage = 'none';
                avatar.style.backgroundColor = '#111';
            }
            avatar.style.borderColor = char.color || '#333';

            // Color badge
            document.getElementById('info-color-badge').style.backgroundColor = char.color || '#888';

            // Aliases
            const aliasesRow = document.getElementById('info-aliases-row');
            if (char.aliases && char.aliases.length > 0) {
                document.getElementById('info-aliases').innerText = char.aliases.join(', ');
                aliasesRow.style.display = 'flex';
            } else {
                aliasesRow.style.display = 'none';
            }

            // Status
            document.getElementById('info-status').innerText = char.status || 'Unknown';

            // Bio
            const bioRow = document.getElementById('info-bio-row');
            if (char.bio && char.bio.trim() !== '') {
                document.getElementById('info-bio').innerText = char.bio;
                bioRow.style.display = 'flex';
            } else {
                bioRow.style.display = 'none';
            }

            document.getElementById('character-info-overlay').style.display = 'flex';
        }

        function closeCharacterInfo() {
            document.getElementById('character-info-overlay').style.display = 'none';
            viewingCharacterId = null;
        }

        
        function handleDeleteYear() {
            if(!selectedYear || !confirm(`Delete Episode ${selectedYear} and all its data?`)) return;
            
            const idx = currentUniverse.years.indexOf(selectedYear);
            currentUniverse.years.splice(idx, 1);
            delete plotsByYear[selectedYear];
            
            if(currentUniverse.years.length > 0) {
                selectYear(currentUniverse.years[0]);
            } else {
                selectedYear = null;
                document.getElementById('node-group').style.display = 'none';
                renderTimeline();
            }
            saveData();
        }

        // --- SAVE/LOAD SYSTEM ---
        function saveData() {
            if (!universeId) {
                console.warn('No universe ID - data will not persist');
                return;
            }
            
            const storageKey = `alphaline_universe_${universeId}`;
            localStorage.setItem(storageKey, JSON.stringify({
                years: currentUniverse.years,
                plots: plotsByYear,
                characters: characters
            }));
            
            // Update last edited timestamp in universes list
            const universes = JSON.parse(localStorage.getItem('alphaline_universes') || '[]');
            const universeEntry = universes.find(u => u.id === parseInt(universeId));
            if (universeEntry) {
                const date = new Date().toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'}).toUpperCase();
                universeEntry.lastEdited = date;
                localStorage.setItem('alphaline_universes', JSON.stringify(universes));
            }
            
            document.getElementById('save-status').innerText = 'CHANGES SYNCED';
            
            // Brief flash to show save
            setTimeout(() => {
                document.getElementById('save-status').style.color = '#4a4';
            }, 100);
            setTimeout(() => {
                document.getElementById('save-status').style.color = '#444';
            }, 800);
        }

        function loadData() {
            if (!universeId) {
                console.warn('No universe ID - cannot load data');
                renderTimeline();
                return;
            }
            
            const storageKey = `alphaline_universe_${universeId}`;
            const saved = localStorage.getItem(storageKey);
            
            if(saved) {
                try {
                    const data = JSON.parse(saved);
                    currentUniverse.years = data.years || [];
                    plotsByYear = data.plots || {};
                    characters = data.characters || [];
                    
                    if(currentUniverse.years.length > 0) {
                        selectYear(currentUniverse.years[0]);
                    }
                } catch(e) {
                    console.error('Failed to load saved data:', e);
                }
            }
            renderTimeline();
        }

        // Initialize on page load
        initTrashZone(); // Setup trash zone ONCE
        loadThemePreference(); // Load saved theme
        loadData();
        
        // Allow Enter key to confirm year modal
        document.getElementById('year-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') confirmNewYear();
        });
    </script>
</body>
</html>
