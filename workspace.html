<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLine | Workspace</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@300&display=swap');
        :root { --bg: #000; --ui-bg: #080808; --text-dim: #666; --accent: #fff; --danger: #ff4444; }
        
        html, body { 
            margin: 0; padding: 0; height: 100vh; width: 100vw; 
            background: var(--bg); color: #fff; 
            font-family: 'Inter', sans-serif; overflow: hidden;
            user-select: none; -webkit-user-select: none;
        }

        /* --- HEADER UI (Restored) --- */
        .workspace-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 65px;
            background: var(--ui-bg); border-bottom: 1px solid #222;
            display: flex; align-items: center; padding: 0 2rem; box-sizing: border-box; z-index: 2000;
        }
        .brand-block { display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
        .back-btn { cursor: pointer; color: var(--text-dim); font-size: 1.2rem; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .back-btn:hover { color: #fff; }
        .nav-text { font-size: 0.7rem; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); }
        .nav-text strong { color: #fff; font-weight: 800; }
        .title-sep { margin: 0 15px; color: #333; }
        .status-block { margin-left: auto; display: flex; align-items: center; gap: 40px; text-align: right; flex-shrink: 0; }
        .clock-block { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-dim); line-height: 1.3; white-space: nowrap; }

        /* --- PLANE --- */
        #plane-container { 
            width: 100vw; height: calc(100vh - 65px); margin-top: 65px;
            background-color: #000;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(rgba(255, 255, 255, 0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.07) 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative; overflow: hidden; cursor: crosshair;
        }

        /* --- GRID NODES --- */
        #node-group {
            position: absolute; left: 50%; top: 50%; 
            display: none; flex-direction: column; align-items: center;
            transform-origin: center; z-index: 100;
        }
        .grid-node {
            padding: 20px 40px; background: rgba(15, 15, 15, 0.75); 
            backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); 
            display: flex; flex-direction: column; align-items: center;
        }
        .grid-node h2 { font-family: 'JetBrains Mono'; font-size: 2.5rem; margin: 0; letter-spacing: 6px; font-weight: 300; }
        .node-label { font-size: 0.5rem; color: #888; letter-spacing: 4px; font-weight: 800; }
        .node-pipe { width: 1px; height: 30px; background: rgba(255,255,255,0.2); }
        .sub-node {
            padding: 15px 30px; background: rgba(10, 10, 10, 0.6); 
            backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 50px; text-align: center;
        }

        /* --- PLOT NODES --- */
        .plot-node {
            width: 500px; background: rgba(12, 12, 12, 0.85); border: 1px solid #333;
            border-radius: 15px; padding: 25px; display: flex; flex-direction: column; gap: 20px;
        }
        .plot-title-field {
            background: transparent; border: none; border-bottom: 1px solid #222;
            color: #fff; font-size: 0.8rem; letter-spacing: 3px; text-transform: uppercase;
            padding-bottom: 8px; outline: none; width: 100%; font-family: 'JetBrains Mono';
        }
        .event-node {
            display: flex; background: rgba(0,0,0,0.5); border: 1px solid #222;
            border-radius: 30px; overflow: hidden; align-items: stretch;
        }
        .event-left { flex: 1; padding: 15px 20px; }
        .event-input {
            background: transparent; border: none; color: #ddd; resize: none;
            width: 100%; font-size: 0.75rem; line-height: 1.6; outline: none;
            font-family: 'Inter', sans-serif;
        }
        .event-right { width: 120px; background: #111; border-left: 1px solid #222; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .event-right img { width: 100%; height: 100%; object-fit: cover; }

        /* --- TIMELINE HUD --- */
        #timeline-hud {
            position: fixed; left: 50%; top: 105px; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 1500;
        }
        #timeline-bar {
            width: 600px; height: 40px; background: rgba(8, 8, 8, 0.95); 
            border: 2px solid var(--accent); border-radius: 4px; position: relative;
        }
        .timeline-axis { position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: rgba(255, 255, 255, 0.2); transform: translateY(-50%); }

        /* --- BUTTONS (Centered) --- */
        .timeline-controls { display: flex; justify-content: center; gap: 10px; width: 100%; }

        /* --- YEAR MARKERS & BOXES --- */
        .year-dot, .year-line { cursor: pointer; transition: 0.2s; position: absolute; top: 50%; transform: translate(-50%, -50%); }
        .year-dot { width: 30px; height: 30px; background: #fff; border-radius: 50%; z-index: 20; }
        .year-line { width: 2px; height: 20px; background: rgba(255,255,255,0.4); z-index: 10; }
        .selected-marker { box-shadow: 0 0 20px 5px rgba(255,255,255,0.4); background: #fff !important; height: 35px !important; z-index: 30 !important; }

        .year-box {
            position: absolute; background: #000; border: 1px solid #444; padding: 4px 10px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: #fff; pointer-events: none;
        }
        .box-min { right: 100%; margin-right: 20px; top: 50%; transform: translateY(-50%); }
        .box-max { left: 100%; margin-left: 20px; top: 50%; transform: translateY(-50%); }
        .box-above { bottom: 100%; margin-bottom: 15px; left: 50%; transform: translateX(-50%); }
        .blip-box { opacity: 0; transition: opacity 0.2s; }
        .year-line:hover .blip-box, .selected-marker .blip-box { opacity: 1; }

        .add-circle { width: 35px; height: 35px; border: 1px solid rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; transition: 0.3s; }
        .add-circle:hover { border-color: #fff; color: #fff; }
        .tm-btn { background: #111; border: 1px solid #333; color: #666; font-size: 0.55rem; padding: 8px 16px; text-transform: uppercase; cursor: pointer; }
        .tm-btn.danger { color: var(--danger); }
    </style>
</head>
<body>

    <header class="workspace-header">
        <div class="brand-block">
            <div class="back-btn" onclick="exitWorkspace()">‚Üê</div>
            <div class="nav-text"><strong>ALPHALINE</strong> <span class="title-sep">|</span> CREATION PLANE <span class="title-sep">|</span> <span id="active-universe-name">UNNAMED</span></div>
        </div>
        <div class="status-block">
            <div style="font-size: 0.6rem; color: #444; letter-spacing: 1px;">PROJECT SAVED</div>
            <div id="workspace-clock" class="clock-block"></div>
        </div>
    </header>

    <div id="plane-container">
        <div id="node-group">
            <div class="grid-node">
                <div class="node-label">YEAR</div>
                <h2 id="grid-year-display">0000</h2>
            </div>
            <div class="node-pipe"></div>
            <div class="sub-node">
                <div class="node-label">CHARACTERS</div>
                <div style="font-size: 0.5rem; color: #444; font-style: italic;">Drag Profiles here to link.</div>
            </div>
            <div class="node-pipe"></div>
            <div id="plot-root" style="display:flex; flex-direction:column; align-items:center;">
                <div class="add-circle" onclick="addPlotNode()">+</div>
                <div id="plot-stack"></div>
            </div>
        </div>
        
        <div id="timeline-hud">
            <div id="timeline-bar"></div>
            <div class="timeline-controls">
                <button id="distribute-btn" class="tm-btn" onclick="toggleDistribution()">Distribute Years</button>
                <button class="tm-btn" onclick="openYearModal()">+ New Year</button>
                <button id="delete-btn" class="tm-btn danger" style="display:none;" onclick="handleDeleteYear()">Delete Year</button>
            </div>
        </div>
    </div>

    <script>
        let currentUniverse = { years: [] };
        let plotsByYear = {}; 
        let selectedYear = null;
        let isDistributed = false;
        let panX = 0, panY = 0, gridZoom = 1;
        let isPanningGrid = false, startX, startY;

        function updateClock() {
            const now = new Date();
            const pst = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
            document.getElementById('workspace-clock').innerHTML = `LOS ANGELES | ${now.toLocaleTimeString().toUpperCase()}<br>${pst.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}).toUpperCase()} PST | ${now.toLocaleDateString().toUpperCase()}`;
        }
        setInterval(updateClock, 1000); updateClock();

        function exitWorkspace() { window.top.document.getElementById('content-frame').src = 'universes.html'; window.top.document.body.classList.remove('workspace-mode'); }

        const plane = document.getElementById('plane-container');
        const nodeGroup = document.getElementById('node-group');

        plane.addEventListener('mousedown', (e) => {
            if (e.target.closest('#timeline-hud') || e.target.closest('.workspace-header') || e.target.closest('.plot-node')) return;
            isPanningGrid = true; plane.style.cursor = 'grabbing';
            startX = e.clientX - panX; startY = e.clientY - panY;
        });
        window.addEventListener('mousemove', (e) => {
            if (!isPanningGrid) return;
            panX = e.clientX - startX; panY = e.clientY - startY;
            updateGridTransform();
        });
        window.addEventListener('mouseup', () => { isPanningGrid = false; plane.style.cursor = 'crosshair'; });
        plane.addEventListener('wheel', (e) => {
            if (e.target.closest('#timeline-hud')) return;
            e.preventDefault();
            gridZoom *= (e.deltaY < 0 ? 1.1 : 0.9);
            gridZoom = Math.max(0.1, Math.min(gridZoom, 5));
            updateGridTransform();
        }, { passive: false });

        function updateGridTransform() {
            const bS = 20 * gridZoom;
            plane.style.backgroundSize = `${bS}px ${bS}px, ${bS}px ${bS}px`;
            plane.style.backgroundPosition = `${panX}px ${panY}px`;
            nodeGroup.style.transform = `translate(calc(-50% + ${panX}px), calc(-50% + ${panY}px)) scale(${gridZoom})`;
        }

        function selectYear(y) {
            selectedYear = y;
            document.getElementById('grid-year-display').innerText = y;
            nodeGroup.style.display = 'flex';
            document.getElementById('delete-btn').style.display = 'block';
            renderPlotStack();
            renderTimelineMarkers();
            updateGridTransform();
        }

        function renderTimelineMarkers() {
            const bar = document.getElementById('timeline-bar');
            bar.innerHTML = '<div class="timeline-axis"></div>';
            const years = currentUniverse.years;
            if (!years.length) return;
            const min = years[0], max = years[years.length-1], range = max-min;

            years.forEach((y, i) => {
                const marker = document.createElement('div');
                const box = document.createElement('div');
                box.className = 'year-box';
                box.innerText = y;

                const pos = isDistributed ? (i/(years.length-1||1))*100 : ((y-min)/(range||1))*100;
                marker.style.left = pos + '%';

                if (i === 0) { marker.className = 'year-dot'; box.classList.add('box-min'); }
                else if (i === years.length-1) { marker.className = 'year-dot'; box.classList.add('box-max'); }
                else { marker.className = 'year-line'; box.classList.add('box-above', 'blip-box'); }

                if (y === selectedYear) marker.classList.add('selected-marker');
                
                marker.onclick = (e) => { e.stopPropagation(); selectYear(y); };
                marker.appendChild(box);
                bar.appendChild(marker);
            });
        }

        function openYearModal() {
            const val = prompt("Enter Temporal Year:");
            if (val && !currentUniverse.years.includes(parseInt(val))) {
                currentUniverse.years.push(parseInt(val));
                currentUniverse.years.sort((a,b)=>a-b);
                renderTimelineMarkers();
            }
        }

        function toggleDistribution() { 
            isDistributed = !isDistributed; 
            document.getElementById('distribute-btn').innerText = isDistributed ? "Linear View" : "Distribute Years";
            renderTimelineMarkers(); 
        }

        function handleDeleteYear() {
            if (confirm(`CAUTION: Delete year ${selectedYear}?`)) {
                currentUniverse.years = currentUniverse.years.filter(y => y !== selectedYear);
                selectedYear = null;
                nodeGroup.style.display = 'none';
                document.getElementById('delete-btn').style.display = 'none';
                renderTimelineMarkers();
            }
        }

        function addPlotNode() {
            if (!selectedYear) return;
            if (!plotsByYear[selectedYear]) plotsByYear[selectedYear] = [];
            plotsByYear[selectedYear].push({ title: 'New Thread', events: [] });
            renderPlotStack();
        }

        function renderPlotStack() {
            const stack = document.getElementById('plot-stack');
            stack.innerHTML = '';
            if (!plotsByYear[selectedYear]) return;
            plotsByYear[selectedYear].forEach((plot, pIdx) => {
                const p = document.createElement('div'); p.className = 'node-pipe'; stack.appendChild(p);
                const n = document.createElement('div'); n.className = 'plot-node';
                n.innerHTML = `<input class="plot-title-field" value="${plot.title}">
                               <div id="ev-s-${pIdx}"></div>
                               <button class="tm-btn" onclick="addEv(${pIdx})">+ Add Event</button>`;
                stack.appendChild(n);
                const evs = n.querySelector(`#ev-s-${pIdx}`);
                plot.events.forEach(e => {
                    const row = document.createElement('div'); row.className = 'event-node';
                    row.innerHTML = `<div class="event-left"><textarea class="event-input">${e.text}</textarea></div><div class="event-right">IMG</div>`;
                    evs.appendChild(row);
                });
            });
        }
        function addEv(idx) { plotsByYear[selectedYear][idx].events.push({text:'',img:null}); renderPlotStack(); }
    </script>
</body>
</html>
