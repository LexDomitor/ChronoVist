<div id="timeline-hud">
    <div id="timeline-bar"></div>
    <div class="timeline-controls">
        <button class="tm-btn" onclick="Engine.resetZoom()">Reset Timeline Zoom</button>
        <button class="tm-btn" onclick="openYearModal()">+ New Year</button>
    </div>
</div>

<script>
    // --- THE TIMELINE ENGINE ---
    const Engine = {
        years: [],
        viewMin: null,
        viewMax: null,
        isPanning: false,
        lastX: 0,
        showAllTimer: null,

        // Initialize or Reset the zoom to show all data
        resetZoom: function() {
            if (this.years.length === 0) return;
            this.viewMin = this.years[0];
            this.viewMax = this.years[this.years.length - 1];
            this.render();
        },

        // Temporary display of all labels during zoom/pan
        triggerFlash: function() {
            if (this.showAllTimer) clearTimeout(this.showAllTimer);
            this.showAllTimer = setTimeout(() => {
                this.showAllTimer = null;
                this.render();
            }, 5000);
            this.render();
        },

        render: function() {
            const bar = document.getElementById('timeline-bar');
            bar.innerHTML = '<div class="timeline-axis"></div>';
            if (this.years.length === 0) return;

            const vMin = this.viewMin;
            const vMax = this.viewMax;
            const vRange = vMax - vMin;
            const actualMin = this.years[0];
            const actualMax = this.years[this.years.length - 1];

            this.years.forEach(y => {
                // Resolution Clipping: Only show what's in the window
                // We allow a tiny buffer so markers don't "pop" in/out harshly
                if (vRange > 0 && (y < vMin || y > vMax)) return;

                const marker = document.createElement('div');
                const box = document.createElement('div');
                box.className = 'year-box';
                
                // Persistence Logic: Anchors get the "..."
                let label = y.toString();
                if (y === vMin && y > actualMin) label = "..." + label;
                if (y === vMax && y < actualMax) label = label + "...";
                box.innerText = label;

                // Position calculation based on Viewport Window
                if (vRange === 0 || y === vMin) {
                    marker.className = 'year-dot';
                    marker.style.left = '0%';
                    box.classList.add('box-min');
                } else if (y === vMax) {
                    marker.className = 'year-dot';
                    marker.style.left = '100%';
                    box.classList.add('box-max');
                } else {
                    marker.className = 'year-line';
                    const pct = ((y - vMin) / vRange) * 100;
                    marker.style.left = pct + '%';
                    box.classList.add('box-above', 'blip-box');
                }
                
                // Show labels if we are in the 5-second "Flash" window
                if (this.showAllTimer) marker.classList.add('force-visible');
                
                marker.appendChild(box);
                bar.appendChild(marker);
            });
        }
    };

    // --- SYSTEM CLOCK (Keeping Header Safe) ---
    function updateClock() {
        const now = new Date();
        document.getElementById('workspace-clock').innerHTML = 
            `LOS ANGELES | ${now.toLocaleTimeString().toUpperCase()}<br>${now.toLocaleDateString().toUpperCase()}`;
    }
    setInterval(updateClock, 1000); updateClock();

    // --- MODAL & DATA ---
    function openYearModal() { document.getElementById('year-modal').style.display = 'flex'; document.getElementById('year-input').focus(); }
    function closeYearModal() { document.getElementById('year-modal').style.display = 'none'; document.getElementById('year-input').value = ''; }

    function confirmNewYear() {
        const val = parseInt(document.getElementById('year-input').value);
        if (!isNaN(val) && !Engine.years.includes(val)) {
            Engine.years.push(val);
            Engine.years.sort((a,b) => a-b);
            if (Engine.years.length === 1) {
                Engine.viewMin = val; Engine.viewMax = val;
            } else {
                // If it's the first time zooming, or out of range, show all
                Engine.resetZoom(); 
            }
            Engine.render();
        }
        closeYearModal();
    }

    // --- INTERACTION LISTENERS ---
    const bar = document.getElementById('timeline-bar');

    // Focal Point Zooming
    bar.addEventListener('wheel', (e) => {
        e.preventDefault();
        if (Engine.years.length < 2) return;

        const rect = bar.getBoundingClientRect();
        const mousePct = (e.clientX - rect.left) / rect.width;
        const focalYear = Engine.viewMin + (mousePct * (Engine.viewMax - Engine.viewMin));
        
        const zoomIn = e.deltaY < 0;
        const factor = zoomIn ? 0.85 : 1.15; // 15% zoom steps
        const newRange = (Engine.viewMax - Engine.viewMin) * factor;
        
        // Recalculate window centered on mouse focal point
        Engine.viewMin = focalYear - (mousePct * newRange);
        Engine.viewMax = focalYear + ((1 - mousePct) * newRange);

        Engine.triggerFlash();
    });

    // Panning (Grabbing and Pulling)
    bar.addEventListener('mousedown', (e) => {
        Engine.isPanning = true;
        Engine.lastX = e.clientX;
        bar.style.cursor = 'grabbing';
    });

    window.addEventListener('mousemove', (e) => {
        if (!Engine.isPanning) return;
        const deltaX = e.clientX - Engine.lastX;
        const rect = bar.getBoundingClientRect();
        
        // Temporal Density Math
        const yearPerPixel = (Engine.viewMax - Engine.viewMin) / rect.width;
        const yearShift = deltaX * yearPerPixel;
        
        Engine.viewMin -= yearShift;
        Engine.viewMax -= yearShift;
        Engine.lastX = e.clientX;
        
        Engine.triggerFlash();
    });

    window.addEventListener('mouseup', () => {
        Engine.isPanning = false;
        bar.style.cursor = 'ew-resize';
    });
</script>
